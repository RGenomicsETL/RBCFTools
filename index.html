<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>`htslib` And `bcftools` Libraries And Command Line Tools Wrapper • RBCFTools</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="`htslib` And `bcftools` Libraries And Command Line Tools Wrapper">
<meta name="description" content="Bundles the htslib and bcftools libraries and command lines tools for reading and manipulating VCF/BCF files. Includes experimental streaming facilities from VCF to Apache Arrow via nanoarrow, enabling export to Arrow IPC format and Parquet format using duckdb.">
<meta property="og:description" content="Bundles the htslib and bcftools libraries and command lines tools for reading and manipulating VCF/BCF files. Includes experimental streaming facilities from VCF to Apache Arrow via nanoarrow, enabling export to Arrow IPC format and Parquet format using duckdb.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">RBCFTools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.22-0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RGenomicsETL/RBCFTools/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="rbcftools">RBCFTools<a class="anchor" aria-label="anchor" href="#rbcftools"></a>
</h1></div>
<!-- badges: start -->

<p>RBCFTools provides R bindings to <a href="https://github.com/samtools/bcftools" class="external-link">bcftools</a> and <a href="https://github.com/samtools/htslib" class="external-link">htslib</a>, the standard tools for reading and manipulating VCF/BCF files. The package bundles these libraries and command-line tools (bcftools, bgzip, tabix), so no external installation is required. When compiled with libcurl, remote file access from S3, GCS, and HTTP URLs is supported. The package also includes experimental support for streaming VCF/BCF to Apache Arrow (IPC) format via <a href="https://arrow.apache.org/nanoarrow/" class="external-link">nanoarrow</a>, with export to Parquet format using <a href="https://duckdb.org/" class="external-link">duckdb</a></p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the development version of RBCFTools from <a href="https://github.com/RGenomicsETL/RBCFTools" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'RBCFTools'</span>, repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'https://rgenomicsetl.r-universe.dev'</span>, <span class="st">'https://cloud.r-project.org'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="version-information">Version Information<a class="anchor" aria-label="anchor" href="#version-information"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RGenomicsETL/RBCFTools" class="external-link">RBCFTools</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get library versions</span></span>
<span><span class="fu"><a href="reference/bcftools_version.html">bcftools_version</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1.23"</span></span>
<span><span class="fu"><a href="reference/htslib_version.html">htslib_version</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1.23"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tool-paths">Tool Paths<a class="anchor" aria-label="anchor" href="#tool-paths"></a>
</h2>
<p>RBCFTools bundles bcftools and htslib command-line tools. Use the path functions to locate the executables</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/bcftools_path.html">bcftools_path</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/usr/lib64/R/library/RBCFTools/bcftools/bin/bcftools"</span></span>
<span><span class="fu"><a href="reference/bgzip_path.html">bgzip_path</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/usr/lib64/R/library/RBCFTools/htslib/bin/bgzip"</span></span>
<span><span class="fu"><a href="reference/tabix_path.html">tabix_path</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/usr/lib64/R/library/RBCFTools/htslib/bin/tabix"</span></span>
<span><span class="co"># List all available tools</span></span>
<span><span class="fu"><a href="reference/bcftools_tools.html">bcftools_tools</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "bcftools"        "color-chrs.pl"   "gff2gff"         "gff2gff.py"     </span></span>
<span><span class="co">#&gt;  [5] "guess-ploidy.py" "plot-roh.py"     "plot-vcfstats"   "roh-viz"        </span></span>
<span><span class="co">#&gt;  [9] "run-roh.pl"      "vcfutils.pl"     "vrfs-variances"</span></span>
<span><span class="fu"><a href="reference/htslib_tools.html">htslib_tools</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "annot-tsv" "bgzip"     "htsfile"   "ref-cache" "tabix"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="capabilities">Capabilities<a class="anchor" aria-label="anchor" href="#capabilities"></a>
</h2>
<p>Check which features were compiled into htslib</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get all capabilities as a named list</span></span>
<span><span class="fu"><a href="reference/htslib_capabilities.html">htslib_capabilities</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $configure</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $plugins</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $libcurl</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $s3</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $gcs</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $libdeflate</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $lzma</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $bzip2</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $htscodecs</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="co"># Human-readable feature string</span></span>
<span><span class="fu"><a href="reference/htslib_feature_string.html">htslib_feature_string</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "build=configure libcurl=yes S3=yes GCS=yes libdeflate=yes lzma=yes bzip2=yes plugins=yes plugin-path=/usr/lib64/R/library/RBCFTools/htslib/libexec/htslib: htscodecs=1.6.5"</span></span></code></pre></div>
<div class="section level3">
<h3 id="feature-constants">Feature Constants<a class="anchor" aria-label="anchor" href="#feature-constants"></a>
</h3>
<p>Use <code>HTS_FEATURE_*</code> constants to check for specific features</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check individual features</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_LIBCURL</span><span class="op">)</span>  <span class="co"># Remote file access via libcurl</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_S3</span><span class="op">)</span>       </span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_GCS</span><span class="op">)</span>      <span class="co"># Google Cloud Storage</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_LIBDEFLATE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_LZMA</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_BZIP2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>These are useful for conditionally enabling features in your code.</p>
</div>
</div>
<div class="section level2">
<h2 id="example-query-remote-vcf-from-s3-using-bcftools">Example Query Remote VCF from S3 using bcftools<a class="anchor" aria-label="anchor" href="#example-query-remote-vcf-from-s3-using-bcftools"></a>
</h2>
<p>With libcurl support, bcftools can directly query remote files. Here we count variants in a small region from the 1000 Genomes cohort VCF on S3:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setup environment for remote file access (S3/GCS)</span></span>
<span><span class="fu"><a href="reference/setup_hts_env.html">setup_hts_env</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build S3 URL for 1000 Genomes cohort VCF</span></span>
<span><span class="va">s3_base</span> <span class="op">&lt;-</span> <span class="st">"s3://1000genomes-dragen-v3.7.6/data/cohorts/"</span></span>
<span><span class="va">s3_path</span> <span class="op">&lt;-</span> <span class="st">"gvcf-genotyper-dragen-3.7.6/hg19/3202-samples-cohort/"</span></span>
<span><span class="va">vcf_file</span> <span class="op">&lt;-</span> <span class="st">"3202_samples_cohort_gg_chr22.vcf.gz"</span></span>
<span><span class="va">vcf_url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s3_base</span>, <span class="va">s3_path</span>, <span class="va">vcf_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Query a small region (chr22:20000000-20100000) and count variants</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system2.html" class="external-link">system2</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="reference/bcftools_path.html">bcftools_path</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"view"</span>, <span class="st">"-H"</span>, <span class="st">"-r"</span>, <span class="st">"chr22:20000000-20100000"</span>, <span class="va">vcf_url</span><span class="op">)</span>,</span>
<span>  stdout <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  stderr <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4622</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="experimental-vcf-to-arrow">(Experimental) VCF to Arrow<a class="anchor" aria-label="anchor" href="#experimental-vcf-to-arrow"></a>
</h2>
<p>RBCFTools provides streaming VCF/BCF to Apache Arrow (IPC) conversion via <a href="https://arrow.apache.org/nanoarrow/" class="external-link">nanoarrow</a>. This enables integration with tools like <a href="https://github.com/duckdb/duckdb-r" class="external-link">duckdb</a> and Parquet format convertion.</p>
<p>The Arrow conversion performs VCF spec conformance checks on headers (similar to htslib’s <code>bcf_hdr_check_sanity()</code>) and emits R warnings when correcting non-conformant fields</p>
<div class="section level3">
<h3 id="read-vcf-as-arrow-stream">Read VCF as Arrow Stream<a class="anchor" aria-label="anchor" href="#read-vcf-as-arrow-stream"></a>
</h3>
<p>Open BCF as Arrow array stream and read the batches</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">bcf_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"1000G_3samples.bcf"</span>, package <span class="op">=</span> <span class="st">"RBCFTools"</span><span class="op">)</span></span>
<span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_open_arrow.html">vcf_open_arrow</a></span><span class="op">(</span><span class="va">bcf_file</span>, batch_size <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">stream</span><span class="op">$</span><span class="fu">get_next</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/AD should be declared as Number=R per VCF</span></span>
<span><span class="co">#&gt; spec; correcting schema</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/GQ should be Type=Integer per VCF spec, but</span></span>
<span><span class="co">#&gt; header declares Type=Float; using header type</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/GT should be declared as Number=1 per VCF</span></span>
<span><span class="co">#&gt; spec; correcting schema</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/AD should be declared as Number=R per VCF</span></span>
<span><span class="co">#&gt; spec; correcting schema</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/GQ should be Type=Integer per VCF spec, but</span></span>
<span><span class="co">#&gt; header declares Type=Float; using header type</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/GT should be declared as Number=1 per VCF</span></span>
<span><span class="co">#&gt; spec; correcting schema</span></span>
<span></span>
<span><span class="fu">nanoarrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/nanoarrow/latest/r/reference/convert_array.html" class="external-link">convert_array</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span></span>
<span><span class="co">#&gt;    CHROM   POS         ID REF ALT QUAL FILTER INFO.DP INFO.AF       INFO.CB</span></span>
<span><span class="co">#&gt; 1      1 10583 rs58108140   G   A   NA   PASS    1557   0.162 UM,BI,BC,NCBI</span></span>
<span><span class="co">#&gt; 2      1 11508       &lt;NA&gt;   A   G   NA   PASS      23    0.72         BI,BC</span></span>
<span><span class="co">#&gt; 3      1 11565       &lt;NA&gt;   G   T   NA   PASS      45       0         BI,BC</span></span>
<span><span class="co">#&gt; 4      1 13116       &lt;NA&gt;   T   G   NA   PASS    2400   0.016         UM,BI</span></span>
<span><span class="co">#&gt; 5      1 13327       &lt;NA&gt;   G   C   NA   PASS    2798    0.01         BI,BC</span></span>
<span><span class="co">#&gt; 6      1 14699       &lt;NA&gt;   C   G   NA   PASS     408    0.02         BI,BC</span></span>
<span><span class="co">#&gt; 7      1 15274       &lt;NA&gt;   A   T   NA   PASS    1739    0.91         UM,BI</span></span>
<span><span class="co">#&gt; 8      1 15820       &lt;NA&gt;   G   T   NA   PASS    1643   0.114      UM,BI,BC</span></span>
<span><span class="co">#&gt; 9      1 16257       &lt;NA&gt;   G   C   NA   PASS    5301    0.12    BI,BC,NCBI</span></span>
<span><span class="co">#&gt; 10     1 16378       &lt;NA&gt;   T   C   NA   PASS     820    0.51    BI,BC,NCBI</span></span>
<span><span class="co">#&gt; 11     1 28376       &lt;NA&gt;   G   A   NA   PASS    2943   0.026         UM,BI</span></span>
<span><span class="co">#&gt;    INFO.EUR_R2 INFO.AFR_R2 INFO.ASN_R2 INFO.AC INFO.AN samples.HG00098.AD</span></span>
<span><span class="co">#&gt; 1        0.248          NA          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 2        0.001          NA          NA       6       6               NULL</span></span>
<span><span class="co">#&gt; 3           NA       0.003          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 4        0.106       0.286          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 5        0.396       0.481          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 6        0.061       0.184          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 7        0.063       0.194          NA       6       6               NULL</span></span>
<span><span class="co">#&gt; 8        0.147       0.209          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 9        0.627       0.719          NA       1       6               NULL</span></span>
<span><span class="co">#&gt; 10       0.107       0.174          NA       3       6               NULL</span></span>
<span><span class="co">#&gt; 11       0.004       0.020          NA       6       6               NULL</span></span>
<span><span class="co">#&gt;    samples.HG00098.DP samples.HG00098.GL samples.HG00098.GQ samples.HG00098.GT</span></span>
<span><span class="co">#&gt; 1                  NA               NULL               3.28                0|0</span></span>
<span><span class="co">#&gt; 2                  NA               NULL               2.22                1|1</span></span>
<span><span class="co">#&gt; 3                  NA               NULL               1.48                0|0</span></span>
<span><span class="co">#&gt; 4                  NA               NULL               9.17                0|0</span></span>
<span><span class="co">#&gt; 5                  NA               NULL              15.80                0|0</span></span>
<span><span class="co">#&gt; 6                  NA               NULL               6.29                0|0</span></span>
<span><span class="co">#&gt; 7                  NA               NULL               5.08                1|1</span></span>
<span><span class="co">#&gt; 8                  NA               NULL               7.01                0|0</span></span>
<span><span class="co">#&gt; 9                  NA               NULL               5.61                0|0</span></span>
<span><span class="co">#&gt; 10                 NA               NULL               1.29                1|1</span></span>
<span><span class="co">#&gt; 11                 NA               NULL               2.68                1|1</span></span>
<span><span class="co">#&gt;    samples.HG00098.GD samples.HG00098.OG samples.HG00100.AD samples.HG00100.DP</span></span>
<span><span class="co">#&gt; 1                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 2                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 3                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 4                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 5                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 6                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 7                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 8                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 9                  NA                ./.               3, 0                  3</span></span>
<span><span class="co">#&gt; 10                 NA                ./.               3, 1                  1</span></span>
<span><span class="co">#&gt; 11                 NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt;     samples.HG00100.GL samples.HG00100.GQ samples.HG00100.GT samples.HG00100.GD</span></span>
<span><span class="co">#&gt; 1                 NULL               3.28                0|0                 NA</span></span>
<span><span class="co">#&gt; 2                 NULL               2.22                1|1                 NA</span></span>
<span><span class="co">#&gt; 3                 NULL               1.48                0|0                 NA</span></span>
<span><span class="co">#&gt; 4                 NULL               9.17                0|0                 NA</span></span>
<span><span class="co">#&gt; 5                 NULL              15.80                0|0                 NA</span></span>
<span><span class="co">#&gt; 6                 NULL               6.29                0|0                 NA</span></span>
<span><span class="co">#&gt; 7                 NULL               5.08                1|1                 NA</span></span>
<span><span class="co">#&gt; 8                 NULL               7.01                0|0                 NA</span></span>
<span><span class="co">#&gt; 9  0.00, -0.90, -12.68              13.77                0|0                 NA</span></span>
<span><span class="co">#&gt; 10  0.00, -0.30, -3.86               2.95                0|0                 NA</span></span>
<span><span class="co">#&gt; 11                NULL               2.68                1|1                 NA</span></span>
<span><span class="co">#&gt;    samples.HG00100.OG samples.HG00106.AD samples.HG00106.DP  samples.HG00106.GL</span></span>
<span><span class="co">#&gt; 1                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 2                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 3                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 4                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 5                 ./.               2, 0                  2  0.00, -0.60, -8.78</span></span>
<span><span class="co">#&gt; 6                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 7                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 8                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 9                 ./.               1, 1                  2 -3.65, -0.60, -4.09</span></span>
<span><span class="co">#&gt; 10                ./.               4, 5                  2 -2.70, -0.60, -3.86</span></span>
<span><span class="co">#&gt; 11                ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt;    samples.HG00106.GQ samples.HG00106.GT samples.HG00106.GD samples.HG00106.OG</span></span>
<span><span class="co">#&gt; 1                3.28                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 2                2.22                1|1                 NA                ./.</span></span>
<span><span class="co">#&gt; 3                1.48                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 4                9.17                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 5               21.74                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 6                6.29                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 7                5.08                1|1                 NA                ./.</span></span>
<span><span class="co">#&gt; 8                7.01                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 9               25.82                0|1                 NA                ./.</span></span>
<span><span class="co">#&gt; 10              23.85                1|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 11               2.68                1|1                 NA                ./.</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="convert-to-data-frame">Convert to Data Frame<a class="anchor" aria-label="anchor" href="#convert-to-data-frame"></a>
</h3>
<p>Convert entire BCF to data.frame</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>warn <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>  <span class="co"># Suppress warnings</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_to_arrow.html">vcf_to_arrow</a></span><span class="op">(</span><span class="va">bcf_file</span>, as <span class="op">=</span> <span class="st">"data.frame"</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span>, <span class="st">"ALT"</span>, <span class="st">"QUAL"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF ALT QUAL</span></span>
<span><span class="co">#&gt; 1     1 10583   G   A   NA</span></span>
<span><span class="co">#&gt; 2     1 11508   A   G   NA</span></span>
<span><span class="co">#&gt; 3     1 11565   G   T   NA</span></span>
<span><span class="co">#&gt; 4     1 13116   T   G   NA</span></span>
<span><span class="co">#&gt; 5     1 13327   G   C   NA</span></span>
<span><span class="co">#&gt; 6     1 14699   C   G   NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="write-to-arrow-ipc">Write to Arrow IPC<a class="anchor" aria-label="anchor" href="#write-to-arrow-ipc"></a>
</h3>
<p>Arrow IPC (<code>.arrows</code>) format for interoperability with other Arrow tools using nanoarrow’s native streaming writer</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Convert BCF to Arrow IPC</span></span>
<span><span class="va">ipc_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".arrows"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/vcf_to_arrow_ipc.html">vcf_to_arrow_ipc</a></span><span class="op">(</span><span class="va">bcf_file</span>, <span class="va">ipc_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read back with nanoarrow</span></span>
<span><span class="va">ipc_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">nanoarrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/nanoarrow/latest/r/reference/read_nanoarrow.html" class="external-link">read_nanoarrow</a></span><span class="op">(</span><span class="va">ipc_file</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ipc_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span>, <span class="st">"ALT"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF ALT</span></span>
<span><span class="co">#&gt; 1     1 10583   G   A</span></span>
<span><span class="co">#&gt; 2     1 11508   A   G</span></span>
<span><span class="co">#&gt; 3     1 11565   G   T</span></span>
<span><span class="co">#&gt; 4     1 13116   T   G</span></span>
<span><span class="co">#&gt; 5     1 13327   G   C</span></span>
<span><span class="co">#&gt; 6     1 14699   C   G</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="write-to-parquet">Write to Parquet<a class="anchor" aria-label="anchor" href="#write-to-parquet"></a>
</h3>
<p>Using <a href="https://github.com/duckdb/duckdb-r" class="external-link">duckdb</a> to convert BCF to parquet file and perform queries on the parquet file</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">parquet_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".parquet"</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/vcf_to_parquet.html">vcf_to_parquet</a></span><span class="op">(</span><span class="va">bcf_file</span>, <span class="va">parquet_file</span>, compression <span class="op">=</span> <span class="st">"snappy"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Wrote 11 rows to /tmp/RtmpMTHiOi/file38a3e76d021998.parquet</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">duckdb</span><span class="fu">::</span><span class="fu">dbConnect</span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pq_bcf</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"SELECT * FROM '%s' LIMIT 100"</span>, <span class="va">parquet_file</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pq_me</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span></span>
<span>    <span class="va">con</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"SELECT * FROM parquet_metadata('%s')"</span>,</span>
<span>    <span class="va">parquet_file</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span>, shutdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pq_bcf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span>, <span class="st">"ALT"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF ALT</span></span>
<span><span class="co">#&gt; 1     1 10583   G   A</span></span>
<span><span class="co">#&gt; 2     1 11508   A   G</span></span>
<span><span class="co">#&gt; 3     1 11565   G   T</span></span>
<span><span class="co">#&gt; 4     1 13116   T   G</span></span>
<span><span class="co">#&gt; 5     1 13327   G   C</span></span>
<span><span class="co">#&gt; 6     1 14699   C   G</span></span>
<span><span class="va">pq_me</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                    file_name row_group_id row_group_num_rows</span></span>
<span><span class="co">#&gt; 1 /tmp/RtmpMTHiOi/file38a3e76d021998.parquet            0                 11</span></span>
<span><span class="co">#&gt; 2 /tmp/RtmpMTHiOi/file38a3e76d021998.parquet            0                 11</span></span>
<span><span class="co">#&gt; 3 /tmp/RtmpMTHiOi/file38a3e76d021998.parquet            0                 11</span></span>
<span><span class="co">#&gt; 4 /tmp/RtmpMTHiOi/file38a3e76d021998.parquet            0                 11</span></span>
<span><span class="co">#&gt; 5 /tmp/RtmpMTHiOi/file38a3e76d021998.parquet            0                 11</span></span>
<span><span class="co">#&gt; 6 /tmp/RtmpMTHiOi/file38a3e76d021998.parquet            0                 11</span></span>
<span><span class="co">#&gt;   row_group_num_columns row_group_bytes column_id file_offset num_values</span></span>
<span><span class="co">#&gt; 1                    36            3135         0           0         11</span></span>
<span><span class="co">#&gt; 2                    36            3135         1           0         11</span></span>
<span><span class="co">#&gt; 3                    36            3135         2           0         11</span></span>
<span><span class="co">#&gt; 4                    36            3135         3           0         11</span></span>
<span><span class="co">#&gt; 5                    36            3135         4           0         11</span></span>
<span><span class="co">#&gt; 6                    36            3135         5           0         11</span></span>
<span><span class="co">#&gt;       path_in_schema       type  stats_min  stats_max stats_null_count</span></span>
<span><span class="co">#&gt; 1              CHROM BYTE_ARRAY          1          1                0</span></span>
<span><span class="co">#&gt; 2                POS     DOUBLE    10583.0    28376.0                0</span></span>
<span><span class="co">#&gt; 3                 ID BYTE_ARRAY rs58108140 rs58108140               10</span></span>
<span><span class="co">#&gt; 4                REF BYTE_ARRAY          A          T                0</span></span>
<span><span class="co">#&gt; 5 ALT, list, element BYTE_ARRAY          A          T               NA</span></span>
<span><span class="co">#&gt; 6               QUAL     DOUBLE       &lt;NA&gt;       &lt;NA&gt;               11</span></span>
<span><span class="co">#&gt;   stats_distinct_count stats_min_value stats_max_value compression</span></span>
<span><span class="co">#&gt; 1                    1               1               1      SNAPPY</span></span>
<span><span class="co">#&gt; 2                   NA         10583.0         28376.0      SNAPPY</span></span>
<span><span class="co">#&gt; 3                    1      rs58108140      rs58108140      SNAPPY</span></span>
<span><span class="co">#&gt; 4                   NA               A               T      SNAPPY</span></span>
<span><span class="co">#&gt; 5                   NA               A               T      SNAPPY</span></span>
<span><span class="co">#&gt; 6                   NA            &lt;NA&gt;            &lt;NA&gt;      SNAPPY</span></span>
<span><span class="co">#&gt;          encodings index_page_offset dictionary_page_offset data_page_offset</span></span>
<span><span class="co">#&gt; 1 PLAIN_DICTIONARY                NA                      4               24</span></span>
<span><span class="co">#&gt; 2            PLAIN                NA                     NA               52</span></span>
<span><span class="co">#&gt; 3 PLAIN_DICTIONARY                NA                    146              175</span></span>
<span><span class="co">#&gt; 4            PLAIN                NA                     NA              208</span></span>
<span><span class="co">#&gt; 5            PLAIN                NA                     NA              268</span></span>
<span><span class="co">#&gt; 6            PLAIN                NA                     NA              335</span></span>
<span><span class="co">#&gt;   total_compressed_size total_uncompressed_size key_value_metadata</span></span>
<span><span class="co">#&gt; 1                    48                      44               NULL</span></span>
<span><span class="co">#&gt; 2                    94                     113               NULL</span></span>
<span><span class="co">#&gt; 3                    62                      84               NULL</span></span>
<span><span class="co">#&gt; 4                    60                      78               NULL</span></span>
<span><span class="co">#&gt; 5                    67                      85               NULL</span></span>
<span><span class="co">#&gt; 6                    25                      23               NULL</span></span>
<span><span class="co">#&gt;   bloom_filter_offset bloom_filter_length min_is_exact max_is_exact</span></span>
<span><span class="co">#&gt; 1                2261                  47         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 2                  NA                  NA         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 3                2308                  47         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 4                  NA                  NA         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 5                  NA                  NA         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 6                  NA                  NA           NA           NA</span></span>
<span><span class="co">#&gt;   row_group_compressed_bytes geo_bbox.xmin geo_bbox.xmax geo_bbox.ymin</span></span>
<span><span class="co">#&gt; 1                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt; 2                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt; 3                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt; 4                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt; 5                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt; 6                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt;   geo_bbox.ymax geo_bbox.zmin geo_bbox.zmax geo_bbox.mmin geo_bbox.mmax</span></span>
<span><span class="co">#&gt; 1            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt; 2            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt; 3            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt; 4            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt; 5            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt; 6            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt;   geo_types</span></span>
<span><span class="co">#&gt; 1      NULL</span></span>
<span><span class="co">#&gt; 2      NULL</span></span>
<span><span class="co">#&gt; 3      NULL</span></span>
<span><span class="co">#&gt; 4      NULL</span></span>
<span><span class="co">#&gt; 5      NULL</span></span>
<span><span class="co">#&gt; 6      NULL</span></span></code></pre></div>
<p>Use <code>streaming = TRUE</code> to avoid loading the entire VCF into R memory. This streams VCF to Arrow IPC (nanoarrow) and then to Parquet via duckdb, trading memory with serialization overhead using the <a href="https://duckdb.org/community_extensions/extensions/nanoarrow.html" class="external-link">duckdb nanoarrow extension</a></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bcf_larger</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"1000G.ALL.2of4intersection.20100804.genotypes.bcf"</span>, package <span class="op">=</span> <span class="st">"RBCFTools"</span><span class="op">)</span></span>
<span><span class="va">outfile</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".parquet"</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/vcf_to_parquet.html">vcf_to_parquet</a></span><span class="op">(</span></span>
<span>    <span class="va">bcf_larger</span>,</span>
<span>    <span class="va">outfile</span>,</span>
<span>    streaming <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    batch_size <span class="op">=</span> <span class="fl">10000L</span>,</span>
<span>    row_group_size <span class="op">=</span> <span class="fl">100000L</span>,</span>
<span>    compression <span class="op">=</span> <span class="st">"zstd"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Wrote 11 rows to /tmp/RtmpMTHiOi/file38a3e732948d06.parquet (streaming mode)</span></span>
<span><span class="co"># describe using duckdb</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="query-vcf-with-duckdb">Query VCF with duckdb<a class="anchor" aria-label="anchor" href="#query-vcf-with-duckdb"></a>
</h3>
<p>SQL queries on BCF using duckdb package. For now this is somehow limited due to convertion from arrow streams to data frame</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/vcf_query.html">vcf_query</a></span><span class="op">(</span><span class="va">bcf_file</span>, <span class="st">"SELECT CHROM, COUNT(*) as n FROM vcf GROUP BY CHROM"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM  n</span></span>
<span><span class="co">#&gt; 1     1 11</span></span>
<span></span>
<span><span class="co"># Filter variants by position</span></span>
<span><span class="fu"><a href="reference/vcf_query.html">vcf_query</a></span><span class="op">(</span><span class="va">bcf_file</span>, <span class="st">"SELECT CHROM, POS, REF, ALT FROM vcf  LIMIT 5"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF ALT</span></span>
<span><span class="co">#&gt; 1     1 10583   G   A</span></span>
<span><span class="co">#&gt; 2     1 11508   A   G</span></span>
<span><span class="co">#&gt; 3     1 11565   G   T</span></span>
<span><span class="co">#&gt; 4     1 13116   T   G</span></span>
<span><span class="co">#&gt; 5     1 13327   G   C</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="stream-remote-vcf-to-arrow">Stream Remote VCF to Arrow<a class="anchor" aria-label="anchor" href="#stream-remote-vcf-to-arrow"></a>
</h3>
<p>Stream remote VCF region directly to Arrow from S3</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">vcf_url</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s3_base</span>, <span class="va">s3_path</span>, <span class="va">vcf_file</span><span class="op">)</span></span>
<span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_open_arrow.html">vcf_open_arrow</a></span><span class="op">(</span></span>
<span>    <span class="va">vcf_url</span>,</span>
<span>    region <span class="op">=</span> <span class="st">"chr22:16050000-16050500"</span>,</span>
<span>    batch_size <span class="op">=</span> <span class="fl">1000L</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to data.frame</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">nanoarrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/nanoarrow/latest/r/reference/convert_array_stream.html" class="external-link">convert_array_stream</a></span><span class="op">(</span><span class="va">stream</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span>, <span class="st">"ALT"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM      POS REF                  ALT</span></span>
<span><span class="co">#&gt; 1 chr22 16050036   A C        , &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 2 chr22 16050151   T G        , &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 3 chr22 16050213   C T        , &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 4 chr22 16050219   C A        , &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 5 chr22 16050224   A C        , &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 6 chr22 16050229   C A        , &lt;NON_REF&gt;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-index-file-path">Custom Index File Path<a class="anchor" aria-label="anchor" href="#custom-index-file-path"></a>
</h3>
<p>For region queries, an index file is required. By default, RBCFTools looks for <code>.tbi</code> (tabix) or <code>.csi</code> indexes using standard naming conventions. For non-standard index locations such as presigned URLs or custom paths, use the <code>index</code> parameter. Index files are only required for region queries; when reading an entire file without a region filter, no index is needed. VCF files try <code>.tbi</code> first then fall back to <code>.csi</code>, while BCF files use <code>.csi</code> only.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Explicit index file path</span></span>
<span><span class="va">bcf_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"1000G_3samples.bcf"</span>, package <span class="op">=</span> <span class="st">"RBCFTools"</span><span class="op">)</span></span>
<span><span class="va">csi_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"1000G_3samples.bcf.csi"</span>, package <span class="op">=</span> <span class="st">"RBCFTools"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_open_arrow.html">vcf_open_arrow</a></span><span class="op">(</span><span class="va">bcf_file</span>, index <span class="op">=</span> <span class="va">csi_index</span><span class="op">)</span></span>
<span><span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">stream</span><span class="op">$</span><span class="fu">get_next</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">nanoarrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/nanoarrow/latest/r/reference/convert_array.html" class="external-link">convert_array</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF</span></span>
<span><span class="co">#&gt; 1     1 10583   G</span></span>
<span><span class="co">#&gt; 2     1 11508   A</span></span>
<span><span class="co">#&gt; 3     1 11565   G</span></span>
<span></span>
<span><span class="co"># Alternative: htslib ##idx## syntax in filename</span></span>
<span><span class="va">filename_with_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">bcf_file</span>, <span class="st">"##idx##"</span>, <span class="va">csi_index</span><span class="op">)</span></span>
<span><span class="va">stream2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_open_arrow.html">vcf_open_arrow</a></span><span class="op">(</span><span class="va">filename_with_idx</span><span class="op">)</span></span>
<span><span class="va">batch2</span> <span class="op">&lt;-</span> <span class="va">stream2</span><span class="op">$</span><span class="fu">get_next</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">nanoarrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/nanoarrow/latest/r/reference/convert_array.html" class="external-link">convert_array</a></span><span class="op">(</span><span class="va">batch2</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF</span></span>
<span><span class="co">#&gt; 1     1 10583   G</span></span>
<span><span class="co">#&gt; 2     1 11508   A</span></span>
<span><span class="co">#&gt; 3     1 11565   G</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="limitations-and-issues">Limitations and issues<a class="anchor" aria-label="anchor" href="#limitations-and-issues"></a>
</h2>
<p>The Arrow supports involves a lot of copies at the C level, let alone additional copies and converstions when converting to parquet including Arrow IPC file serialization. Same limitation applies to the SQL query interface. In theory we can use the arrow package to get <code>arrow_table</code> format that can be registered by <code>duckdb</code> but this is an additional dependency.</p>
</div>
<div class="section level2">
<h2 id="future-directions">Future directions<a class="anchor" aria-label="anchor" href="#future-directions"></a>
</h2>
<p>We should improve the code, avoid copies, add more tests and maybe <a href="https://github.com/duckdb/ducklake" class="external-link">ducklake</a> support</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li><p><a href="https://samtools.github.io/bcftools/" class="external-link">bcftools documentation</a></p></li>
<li><p><a href="https://github.com/samtools/bcftools" class="external-link">bcftools GitHub</a></p></li>
<li><p><a href="https://github.com/samtools/htslib" class="external-link">htslib GitHub</a></p></li>
<li><p><a href="https://arrow.apache.org/nanoarrow/" class="external-link">arrow-nanoarrow</a></p></li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/RGenomicsETL/RBCFTools/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/RGenomicsETL/RBCFTools/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 3)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing RBCFTools</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Sounkou Mahamane Toure <br><small class="roles"> Author, maintainer </small>   </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/RGenomicsETL/RBCFTools/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/RGenomicsETL/RBCFTools/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sounkou Mahamane Toure.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
