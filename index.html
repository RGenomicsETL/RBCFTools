<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>htslib and bcftools Libraries and Command Line Tools Wrapper • RBCFTools</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="htslib and bcftools Libraries and Command Line Tools Wrapper">
<meta name="description" content="Bundles the htslib and bcftools libraries and command lines tools for reading and manipulating VCF/BCF files. Includes experimental streaming facilities from VCF to Apache Arrow via nanoarrow, enabling export to Arrow IPC format and Parquet format using duckdb.">
<meta property="og:description" content="Bundles the htslib and bcftools libraries and command lines tools for reading and manipulating VCF/BCF files. Includes experimental streaming facilities from VCF to Apache Arrow via nanoarrow, enabling export to Arrow IPC format and Parquet format using duckdb.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">RBCFTools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.23-0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RGenomicsETL/RBCFTools/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="rbcftools">RBCFTools<a class="anchor" aria-label="anchor" href="#rbcftools"></a>
</h1></div>
<!-- badges: start -->

<p>RBCFTools provides R bindings to <a href="https://github.com/samtools/bcftools" class="external-link">bcftools</a> and <a href="https://github.com/samtools/htslib" class="external-link">htslib</a>, the standard tools for reading and manipulating VCF/BCF files. The package bundles these libraries and command-line tools (bcftools, bgzip, tabix), so no external installation is required. When compiled with libcurl, remote file access from S3, GCS, and HTTP URLs is supported. The package also includes experimental support for streaming VCF/BCF to Apache Arrow (IPC) format via <a href="https://arrow.apache.org/nanoarrow/" class="external-link">nanoarrow</a>, with export to Parquet format using <a href="https://duckdb.org/" class="external-link">duckdb</a> via either the <a href="https://duckdb.org/community_extensions/extensions/nanoarrow.html" class="external-link">duckdb nanoarrow extension</a> or a <a href="inst/duckdb_bcf_reader_extension/"><code>bcf_reader</code></a> extension bundled in this package.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the development version of RBCFTools from <a href="https://github.com/RGenomicsETL/RBCFTools" class="external-link">GitHub</a> for unix-alikes (we do not support windows)</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'RBCFTools'</span>, repos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'https://rgenomicsetl.r-universe.dev'</span>, <span class="st">'https://cloud.r-project.org'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="version-information">Version Information<a class="anchor" aria-label="anchor" href="#version-information"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RGenomicsETL/RBCFTools" class="external-link">RBCFTools</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: parallel</span></span>
<span><span class="co">#&gt; Loading required package: vctrs</span></span>
<span></span>
<span><span class="co"># Get library versions</span></span>
<span><span class="fu"><a href="reference/bcftools_version.html">bcftools_version</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1.23"</span></span>
<span><span class="fu"><a href="reference/htslib_version.html">htslib_version</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1.23"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="tool-paths">Tool Paths<a class="anchor" aria-label="anchor" href="#tool-paths"></a>
</h2>
<p>RBCFTools bundles bcftools and htslib command-line tools. Use the path functions to locate the executables</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/bcftools_path.html">bcftools_path</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/usr/lib64/R/library/RBCFTools/bcftools/bin/bcftools"</span></span>
<span><span class="fu"><a href="reference/bgzip_path.html">bgzip_path</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/usr/lib64/R/library/RBCFTools/htslib/bin/bgzip"</span></span>
<span><span class="fu"><a href="reference/tabix_path.html">tabix_path</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/usr/lib64/R/library/RBCFTools/htslib/bin/tabix"</span></span>
<span><span class="co"># List all available tools</span></span>
<span><span class="fu"><a href="reference/bcftools_tools.html">bcftools_tools</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "bcftools"        "color-chrs.pl"   "gff2gff"         "gff2gff.py"     </span></span>
<span><span class="co">#&gt;  [5] "guess-ploidy.py" "plot-roh.py"     "plot-vcfstats"   "roh-viz"        </span></span>
<span><span class="co">#&gt;  [9] "run-roh.pl"      "vcfutils.pl"     "vrfs-variances"</span></span>
<span><span class="fu"><a href="reference/htslib_tools.html">htslib_tools</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "annot-tsv" "bgzip"     "htsfile"   "ref-cache" "tabix"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="capabilities">Capabilities<a class="anchor" aria-label="anchor" href="#capabilities"></a>
</h2>
<p>Check which features were compiled into htslib</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get all capabilities as a named list</span></span>
<span><span class="fu"><a href="reference/htslib_capabilities.html">htslib_capabilities</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; $configure</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $plugins</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $libcurl</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $s3</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $gcs</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $libdeflate</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $lzma</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $bzip2</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $htscodecs</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span></span>
<span><span class="co"># Human-readable feature string</span></span>
<span><span class="fu"><a href="reference/htslib_feature_string.html">htslib_feature_string</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "build=configure libcurl=yes S3=yes GCS=yes libdeflate=yes lzma=yes bzip2=yes plugins=yes plugin-path=/usr/lib64/R/library/RBCFTools/htslib/libexec/htslib: htscodecs=1.6.5"</span></span></code></pre></div>
<div class="section level3">
<h3 id="feature-constants">Feature Constants<a class="anchor" aria-label="anchor" href="#feature-constants"></a>
</h3>
<p>Use <code>HTS_FEATURE_*</code> constants to check for specific features</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check individual features</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_LIBCURL</span><span class="op">)</span>  <span class="co"># Remote file access via libcurl</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_S3</span><span class="op">)</span>       </span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_GCS</span><span class="op">)</span>      <span class="co"># Google Cloud Storage</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_LIBDEFLATE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_LZMA</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="reference/htslib_has_feature.html">htslib_has_feature</a></span><span class="op">(</span><span class="va">HTS_FEATURE_BZIP2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>These are useful for conditionally enabling features in your code.</p>
</div>
</div>
<div class="section level2">
<h2 id="example-query-remote-vcf-from-s3-using-bcftools">Example Query Remote VCF from S3 using bcftools<a class="anchor" aria-label="anchor" href="#example-query-remote-vcf-from-s3-using-bcftools"></a>
</h2>
<p>With libcurl support, bcftools can directly query remote files. Here we count variants in a small region from the 1000 Genomes cohort VCF on S3:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setup environment for remote file access (S3/GCS)</span></span>
<span><span class="fu"><a href="reference/setup_hts_env.html">setup_hts_env</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build S3 URL for 1000 Genomes cohort VCF</span></span>
<span><span class="va">s3_base</span> <span class="op">&lt;-</span> <span class="st">"s3://1000genomes-dragen-v3.7.6/data/cohorts/"</span></span>
<span><span class="va">s3_path</span> <span class="op">&lt;-</span> <span class="st">"gvcf-genotyper-dragen-3.7.6/hg19/3202-samples-cohort/"</span></span>
<span><span class="va">s3_vcf_file</span> <span class="op">&lt;-</span> <span class="st">"3202_samples_cohort_gg_chr22.vcf.gz"</span></span>
<span><span class="va">s3_vcf_uri</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s3_base</span>, <span class="va">s3_path</span>, <span class="va">s3_vcf_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Query a small region (chr22:20000000-20100000) and count variants</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system2.html" class="external-link">system2</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="reference/bcftools_path.html">bcftools_path</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"view"</span>, <span class="st">"-H"</span>, <span class="st">"-r"</span>, <span class="st">"chr22:20000000-20100000"</span>, <span class="va">s3_vcf_uri</span><span class="op">)</span>,</span>
<span>  stdout <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  stderr <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 4622</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="experimental-vcf-to-arrow-streams-and-duckdb-bcf_reader-extension">(Experimental) VCF to Arrow Streams and Duckdb <code>bcf_reader</code> extension<a class="anchor" aria-label="anchor" href="#experimental-vcf-to-arrow-streams-and-duckdb-bcf_reader-extension"></a>
</h2>
<p>RBCFTools provides streaming VCF/BCF to Apache Arrow Stream conversion via <a href="https://arrow.apache.org/nanoarrow/" class="external-link">nanoarrow</a>. This enables integration with tools like <a href="https://github.com/duckdb/duckdb-r" class="external-link">duckdb</a> and Parquet format convertion when serializing to Arrow IPC. We also support the <a href="inst/duckdb_bcf_reader_extension/"><code>bcf_reader</code></a> duckdb extension to read directly into duckb</p>
<p>The <code>nanoarrow</code> stream conversion and <code>bcf_reader</code> perform VCF spec conformance checks on headers (similar to htslib’s <code>bcf_hdr_check_sanity()</code>) and emits R warning or duckdb logs when correcting non-conformant fields</p>
<div class="section level3">
<h3 id="read-vcf-as-arrow-stream">Read VCF as Arrow Stream<a class="anchor" aria-label="anchor" href="#read-vcf-as-arrow-stream"></a>
</h3>
<p>Open BCF as Arrow array stream and read the batches</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">bcf_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"1000G_3samples.bcf"</span>, package <span class="op">=</span> <span class="st">"RBCFTools"</span><span class="op">)</span></span>
<span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_open_arrow.html">vcf_open_arrow</a></span><span class="op">(</span><span class="va">bcf_file</span>, batch_size <span class="op">=</span> <span class="fl">100L</span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">stream</span><span class="op">$</span><span class="fu">get_next</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/AD should be declared as Number=R per VCF</span></span>
<span><span class="co">#&gt; spec; correcting schema</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/GQ should be Type=Integer per VCF spec, but</span></span>
<span><span class="co">#&gt; header declares Type=Float; using header type</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/GT should be declared as Number=1 per VCF</span></span>
<span><span class="co">#&gt; spec; correcting schema</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/AD should be declared as Number=R per VCF</span></span>
<span><span class="co">#&gt; spec; correcting schema</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/GQ should be Type=Integer per VCF spec, but</span></span>
<span><span class="co">#&gt; header declares Type=Float; using header type</span></span>
<span><span class="co">#&gt; Warning in x$get_schema(): FORMAT/GT should be declared as Number=1 per VCF</span></span>
<span><span class="co">#&gt; spec; correcting schema</span></span>
<span></span>
<span><span class="fu">nanoarrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/nanoarrow/latest/r/reference/convert_array.html" class="external-link">convert_array</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span></span>
<span><span class="co">#&gt;    CHROM   POS         ID REF ALT QUAL FILTER INFO.DP INFO.AF       INFO.CB</span></span>
<span><span class="co">#&gt; 1      1 10583 rs58108140   G   A   NA   PASS    1557   0.162 UM,BI,BC,NCBI</span></span>
<span><span class="co">#&gt; 2      1 11508       &lt;NA&gt;   A   G   NA   PASS      23    0.72         BI,BC</span></span>
<span><span class="co">#&gt; 3      1 11565       &lt;NA&gt;   G   T   NA   PASS      45       0         BI,BC</span></span>
<span><span class="co">#&gt; 4      1 13116       &lt;NA&gt;   T   G   NA   PASS    2400   0.016         UM,BI</span></span>
<span><span class="co">#&gt; 5      1 13327       &lt;NA&gt;   G   C   NA   PASS    2798    0.01         BI,BC</span></span>
<span><span class="co">#&gt; 6      1 14699       &lt;NA&gt;   C   G   NA   PASS     408    0.02         BI,BC</span></span>
<span><span class="co">#&gt; 7      1 15274       &lt;NA&gt;   A   T   NA   PASS    1739    0.91         UM,BI</span></span>
<span><span class="co">#&gt; 8      1 15820       &lt;NA&gt;   G   T   NA   PASS    1643   0.114      UM,BI,BC</span></span>
<span><span class="co">#&gt; 9      1 16257       &lt;NA&gt;   G   C   NA   PASS    5301    0.12    BI,BC,NCBI</span></span>
<span><span class="co">#&gt; 10     1 16378       &lt;NA&gt;   T   C   NA   PASS     820    0.51    BI,BC,NCBI</span></span>
<span><span class="co">#&gt; 11     1 28376       &lt;NA&gt;   G   A   NA   PASS    2943   0.026         UM,BI</span></span>
<span><span class="co">#&gt;    INFO.EUR_R2 INFO.AFR_R2 INFO.ASN_R2 INFO.AC INFO.AN samples.HG00098.AD</span></span>
<span><span class="co">#&gt; 1        0.248          NA          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 2        0.001          NA          NA       6       6               NULL</span></span>
<span><span class="co">#&gt; 3           NA       0.003          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 4        0.106       0.286          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 5        0.396       0.481          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 6        0.061       0.184          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 7        0.063       0.194          NA       6       6               NULL</span></span>
<span><span class="co">#&gt; 8        0.147       0.209          NA       0       6               NULL</span></span>
<span><span class="co">#&gt; 9        0.627       0.719          NA       1       6               NULL</span></span>
<span><span class="co">#&gt; 10       0.107       0.174          NA       3       6               NULL</span></span>
<span><span class="co">#&gt; 11       0.004       0.020          NA       6       6               NULL</span></span>
<span><span class="co">#&gt;    samples.HG00098.DP samples.HG00098.GL samples.HG00098.GQ samples.HG00098.GT</span></span>
<span><span class="co">#&gt; 1                  NA               NULL               3.28                0|0</span></span>
<span><span class="co">#&gt; 2                  NA               NULL               2.22                1|1</span></span>
<span><span class="co">#&gt; 3                  NA               NULL               1.48                0|0</span></span>
<span><span class="co">#&gt; 4                  NA               NULL               9.17                0|0</span></span>
<span><span class="co">#&gt; 5                  NA               NULL              15.80                0|0</span></span>
<span><span class="co">#&gt; 6                  NA               NULL               6.29                0|0</span></span>
<span><span class="co">#&gt; 7                  NA               NULL               5.08                1|1</span></span>
<span><span class="co">#&gt; 8                  NA               NULL               7.01                0|0</span></span>
<span><span class="co">#&gt; 9                  NA               NULL               5.61                0|0</span></span>
<span><span class="co">#&gt; 10                 NA               NULL               1.29                1|1</span></span>
<span><span class="co">#&gt; 11                 NA               NULL               2.68                1|1</span></span>
<span><span class="co">#&gt;    samples.HG00098.GD samples.HG00098.OG samples.HG00100.AD samples.HG00100.DP</span></span>
<span><span class="co">#&gt; 1                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 2                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 3                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 4                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 5                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 6                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 7                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 8                  NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt; 9                  NA                ./.               3, 0                  3</span></span>
<span><span class="co">#&gt; 10                 NA                ./.               3, 1                  1</span></span>
<span><span class="co">#&gt; 11                 NA                ./.               NULL                 NA</span></span>
<span><span class="co">#&gt;     samples.HG00100.GL samples.HG00100.GQ samples.HG00100.GT samples.HG00100.GD</span></span>
<span><span class="co">#&gt; 1                 NULL               3.28                0|0                 NA</span></span>
<span><span class="co">#&gt; 2                 NULL               2.22                1|1                 NA</span></span>
<span><span class="co">#&gt; 3                 NULL               1.48                0|0                 NA</span></span>
<span><span class="co">#&gt; 4                 NULL               9.17                0|0                 NA</span></span>
<span><span class="co">#&gt; 5                 NULL              15.80                0|0                 NA</span></span>
<span><span class="co">#&gt; 6                 NULL               6.29                0|0                 NA</span></span>
<span><span class="co">#&gt; 7                 NULL               5.08                1|1                 NA</span></span>
<span><span class="co">#&gt; 8                 NULL               7.01                0|0                 NA</span></span>
<span><span class="co">#&gt; 9  0.00, -0.90, -12.68              13.77                0|0                 NA</span></span>
<span><span class="co">#&gt; 10  0.00, -0.30, -3.86               2.95                0|0                 NA</span></span>
<span><span class="co">#&gt; 11                NULL               2.68                1|1                 NA</span></span>
<span><span class="co">#&gt;    samples.HG00100.OG samples.HG00106.AD samples.HG00106.DP  samples.HG00106.GL</span></span>
<span><span class="co">#&gt; 1                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 2                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 3                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 4                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 5                 ./.               2, 0                  2  0.00, -0.60, -8.78</span></span>
<span><span class="co">#&gt; 6                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 7                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 8                 ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt; 9                 ./.               1, 1                  2 -3.65, -0.60, -4.09</span></span>
<span><span class="co">#&gt; 10                ./.               4, 5                  2 -2.70, -0.60, -3.86</span></span>
<span><span class="co">#&gt; 11                ./.               NULL                 NA                NULL</span></span>
<span><span class="co">#&gt;    samples.HG00106.GQ samples.HG00106.GT samples.HG00106.GD samples.HG00106.OG</span></span>
<span><span class="co">#&gt; 1                3.28                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 2                2.22                1|1                 NA                ./.</span></span>
<span><span class="co">#&gt; 3                1.48                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 4                9.17                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 5               21.74                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 6                6.29                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 7                5.08                1|1                 NA                ./.</span></span>
<span><span class="co">#&gt; 8                7.01                0|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 9               25.82                0|1                 NA                ./.</span></span>
<span><span class="co">#&gt; 10              23.85                1|0                 NA                ./.</span></span>
<span><span class="co">#&gt; 11               2.68                1|1                 NA                ./.</span></span>
<span><span class="va">stream</span><span class="op">$</span><span class="fu">release</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="convert-to-data-frame">Convert to Data Frame<a class="anchor" aria-label="anchor" href="#convert-to-data-frame"></a>
</h3>
<p>Convert entire BCF to data.frame</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>warn <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>  <span class="co"># Suppress warnings</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_to_arrow.html">vcf_to_arrow</a></span><span class="op">(</span><span class="va">bcf_file</span>, as <span class="op">=</span> <span class="st">"data.frame"</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span>, <span class="st">"ALT"</span>, <span class="st">"QUAL"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF ALT QUAL</span></span>
<span><span class="co">#&gt; 1     1 10583   G   A   NA</span></span>
<span><span class="co">#&gt; 2     1 11508   A   G   NA</span></span>
<span><span class="co">#&gt; 3     1 11565   G   T   NA</span></span>
<span><span class="co">#&gt; 4     1 13116   T   G   NA</span></span>
<span><span class="co">#&gt; 5     1 13327   G   C   NA</span></span>
<span><span class="co">#&gt; 6     1 14699   C   G   NA</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="write-to-arrow-ipc">Write to Arrow IPC<a class="anchor" aria-label="anchor" href="#write-to-arrow-ipc"></a>
</h3>
<p>Arrow IPC (<code>.arrows</code>) format for interoperability with other Arrow tools using nanoarrow’s native streaming writer</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Convert BCF to Arrow IPC</span></span>
<span><span class="va">ipc_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".arrows"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/vcf_to_arrow_ipc.html">vcf_to_arrow_ipc</a></span><span class="op">(</span><span class="va">bcf_file</span>, <span class="va">ipc_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read back with nanoarrow</span></span>
<span><span class="va">ipc_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">nanoarrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/nanoarrow/latest/r/reference/read_nanoarrow.html" class="external-link">read_nanoarrow</a></span><span class="op">(</span><span class="va">ipc_file</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ipc_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span>, <span class="st">"ALT"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF ALT</span></span>
<span><span class="co">#&gt; 1     1 10583   G   A</span></span>
<span><span class="co">#&gt; 2     1 11508   A   G</span></span>
<span><span class="co">#&gt; 3     1 11565   G   T</span></span>
<span><span class="co">#&gt; 4     1 13116   T   G</span></span>
<span><span class="co">#&gt; 5     1 13327   G   C</span></span>
<span><span class="co">#&gt; 6     1 14699   C   G</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="write-vcf-streams-to-parquet">Write VCF Streams to Parquet<a class="anchor" aria-label="anchor" href="#write-vcf-streams-to-parquet"></a>
</h3>
<p>Using <a href="https://github.com/duckdb/duckdb-r" class="external-link">duckdb</a> to convert BCF to parquet file and perform queries on the parquet file. This involve vcf stream conversion to data.frame</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">parquet_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".parquet"</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/vcf_to_parquet.html">vcf_to_parquet</a></span><span class="op">(</span><span class="va">bcf_file</span>, <span class="va">parquet_file</span>, compression <span class="op">=</span> <span class="st">"snappy"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Wrote 11 rows to /tmp/Rtmpi2nZ08/file1f99ee4e3dd61c.parquet</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">duckdb</span><span class="fu">::</span><span class="fu">dbConnect</span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pq_bcf</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"SELECT * FROM '%s' LIMIT 100"</span>, <span class="va">parquet_file</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pq_me</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span></span>
<span>    <span class="va">con</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"SELECT * FROM parquet_metadata('%s')"</span>,</span>
<span>    <span class="va">parquet_file</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu">dbDisconnect</span><span class="op">(</span><span class="va">con</span>, shutdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">pq_bcf</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span>, <span class="st">"ALT"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF ALT</span></span>
<span><span class="co">#&gt; 1     1 10583   G   A</span></span>
<span><span class="co">#&gt; 2     1 11508   A   G</span></span>
<span><span class="co">#&gt; 3     1 11565   G   T</span></span>
<span><span class="co">#&gt; 4     1 13116   T   G</span></span>
<span><span class="co">#&gt; 5     1 13327   G   C</span></span>
<span><span class="co">#&gt; 6     1 14699   C   G</span></span>
<span><span class="va">pq_me</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                                    file_name row_group_id row_group_num_rows</span></span>
<span><span class="co">#&gt; 1 /tmp/Rtmpi2nZ08/file1f99ee4e3dd61c.parquet            0                 11</span></span>
<span><span class="co">#&gt; 2 /tmp/Rtmpi2nZ08/file1f99ee4e3dd61c.parquet            0                 11</span></span>
<span><span class="co">#&gt; 3 /tmp/Rtmpi2nZ08/file1f99ee4e3dd61c.parquet            0                 11</span></span>
<span><span class="co">#&gt; 4 /tmp/Rtmpi2nZ08/file1f99ee4e3dd61c.parquet            0                 11</span></span>
<span><span class="co">#&gt; 5 /tmp/Rtmpi2nZ08/file1f99ee4e3dd61c.parquet            0                 11</span></span>
<span><span class="co">#&gt; 6 /tmp/Rtmpi2nZ08/file1f99ee4e3dd61c.parquet            0                 11</span></span>
<span><span class="co">#&gt;   row_group_num_columns row_group_bytes column_id file_offset num_values</span></span>
<span><span class="co">#&gt; 1                    36            3135         0           0         11</span></span>
<span><span class="co">#&gt; 2                    36            3135         1           0         11</span></span>
<span><span class="co">#&gt; 3                    36            3135         2           0         11</span></span>
<span><span class="co">#&gt; 4                    36            3135         3           0         11</span></span>
<span><span class="co">#&gt; 5                    36            3135         4           0         11</span></span>
<span><span class="co">#&gt; 6                    36            3135         5           0         11</span></span>
<span><span class="co">#&gt;       path_in_schema       type  stats_min  stats_max stats_null_count</span></span>
<span><span class="co">#&gt; 1              CHROM BYTE_ARRAY          1          1                0</span></span>
<span><span class="co">#&gt; 2                POS     DOUBLE    10583.0    28376.0                0</span></span>
<span><span class="co">#&gt; 3                 ID BYTE_ARRAY rs58108140 rs58108140               10</span></span>
<span><span class="co">#&gt; 4                REF BYTE_ARRAY          A          T                0</span></span>
<span><span class="co">#&gt; 5 ALT, list, element BYTE_ARRAY          A          T               NA</span></span>
<span><span class="co">#&gt; 6               QUAL     DOUBLE       &lt;NA&gt;       &lt;NA&gt;               11</span></span>
<span><span class="co">#&gt;   stats_distinct_count stats_min_value stats_max_value compression</span></span>
<span><span class="co">#&gt; 1                    1               1               1      SNAPPY</span></span>
<span><span class="co">#&gt; 2                   NA         10583.0         28376.0      SNAPPY</span></span>
<span><span class="co">#&gt; 3                    1      rs58108140      rs58108140      SNAPPY</span></span>
<span><span class="co">#&gt; 4                   NA               A               T      SNAPPY</span></span>
<span><span class="co">#&gt; 5                   NA               A               T      SNAPPY</span></span>
<span><span class="co">#&gt; 6                   NA            &lt;NA&gt;            &lt;NA&gt;      SNAPPY</span></span>
<span><span class="co">#&gt;          encodings index_page_offset dictionary_page_offset data_page_offset</span></span>
<span><span class="co">#&gt; 1 PLAIN_DICTIONARY                NA                      4               24</span></span>
<span><span class="co">#&gt; 2            PLAIN                NA                     NA               52</span></span>
<span><span class="co">#&gt; 3 PLAIN_DICTIONARY                NA                    146              175</span></span>
<span><span class="co">#&gt; 4            PLAIN                NA                     NA              208</span></span>
<span><span class="co">#&gt; 5            PLAIN                NA                     NA              268</span></span>
<span><span class="co">#&gt; 6            PLAIN                NA                     NA              335</span></span>
<span><span class="co">#&gt;   total_compressed_size total_uncompressed_size key_value_metadata</span></span>
<span><span class="co">#&gt; 1                    48                      44               NULL</span></span>
<span><span class="co">#&gt; 2                    94                     113               NULL</span></span>
<span><span class="co">#&gt; 3                    62                      84               NULL</span></span>
<span><span class="co">#&gt; 4                    60                      78               NULL</span></span>
<span><span class="co">#&gt; 5                    67                      85               NULL</span></span>
<span><span class="co">#&gt; 6                    25                      23               NULL</span></span>
<span><span class="co">#&gt;   bloom_filter_offset bloom_filter_length min_is_exact max_is_exact</span></span>
<span><span class="co">#&gt; 1                2261                  47         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 2                  NA                  NA         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 3                2308                  47         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 4                  NA                  NA         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 5                  NA                  NA         TRUE         TRUE</span></span>
<span><span class="co">#&gt; 6                  NA                  NA           NA           NA</span></span>
<span><span class="co">#&gt;   row_group_compressed_bytes geo_bbox.xmin geo_bbox.xmax geo_bbox.ymin</span></span>
<span><span class="co">#&gt; 1                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt; 2                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt; 3                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt; 4                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt; 5                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt; 6                          1            NA            NA            NA</span></span>
<span><span class="co">#&gt;   geo_bbox.ymax geo_bbox.zmin geo_bbox.zmax geo_bbox.mmin geo_bbox.mmax</span></span>
<span><span class="co">#&gt; 1            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt; 2            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt; 3            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt; 4            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt; 5            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt; 6            NA            NA            NA            NA            NA</span></span>
<span><span class="co">#&gt;   geo_types</span></span>
<span><span class="co">#&gt; 1      NULL</span></span>
<span><span class="co">#&gt; 2      NULL</span></span>
<span><span class="co">#&gt; 3      NULL</span></span>
<span><span class="co">#&gt; 4      NULL</span></span>
<span><span class="co">#&gt; 5      NULL</span></span>
<span><span class="co">#&gt; 6      NULL</span></span></code></pre></div>
<p>Use <code>streaming = TRUE</code> to avoid loading the entire VCF into R memory. This streams VCF to Arrow IPC (nanoarrow) and then to Parquet via duckdb, trading memory with serialization overhead using the <a href="https://duckdb.org/community_extensions/extensions/nanoarrow.html" class="external-link">duckdb nanoarrow extension</a></p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bcf_larger</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"1000G.ALL.2of4intersection.20100804.genotypes.bcf"</span>, package <span class="op">=</span> <span class="st">"RBCFTools"</span><span class="op">)</span></span>
<span><span class="va">outfile</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".parquet"</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/vcf_to_parquet.html">vcf_to_parquet</a></span><span class="op">(</span></span>
<span>    <span class="va">bcf_larger</span>,</span>
<span>    <span class="va">outfile</span>,</span>
<span>    streaming <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    batch_size <span class="op">=</span> <span class="fl">10000L</span>,</span>
<span>    row_group_size <span class="op">=</span> <span class="fl">100000L</span>,</span>
<span>    compression <span class="op">=</span> <span class="st">"zstd"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Wrote 11 rows to /tmp/Rtmpi2nZ08/file1f99ee1c05cb87.parquet (streaming mode)</span></span>
<span><span class="co"># describe using duckdb</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="query-vcf-with-duckdb-after-converting-the-stream">Query VCF with duckdb after converting the Stream<a class="anchor" aria-label="anchor" href="#query-vcf-with-duckdb-after-converting-the-stream"></a>
</h3>
<p>SQL queries on BCF using duckdb package. For now this is somehow limited due to convertion from arrow streams to data frame</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="reference/vcf_query.html">vcf_query</a></span><span class="op">(</span><span class="va">bcf_file</span>, <span class="st">"SELECT CHROM, COUNT(*) as n FROM vcf GROUP BY CHROM"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM  n</span></span>
<span><span class="co">#&gt; 1     1 11</span></span>
<span></span>
<span><span class="co"># Filter variants by position</span></span>
<span><span class="fu"><a href="reference/vcf_query.html">vcf_query</a></span><span class="op">(</span><span class="va">bcf_file</span>, <span class="st">"SELECT CHROM, POS, REF, ALT FROM vcf  LIMIT 5"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF ALT</span></span>
<span><span class="co">#&gt; 1     1 10583   G   A</span></span>
<span><span class="co">#&gt; 2     1 11508   A   G</span></span>
<span><span class="co">#&gt; 3     1 11565   G   T</span></span>
<span><span class="co">#&gt; 4     1 13116   T   G</span></span>
<span><span class="co">#&gt; 5     1 13327   G   C</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="query-vcf-with-duckdb-extension">Query VCF with DuckDB Extension<a class="anchor" aria-label="anchor" href="#query-vcf-with-duckdb-extension"></a>
</h3>
<p>A native DuckDB extension (<code>bcf_reader</code>) for direct SQL queries on VCF/BCF files without Arrow conversion overhead. The extension uses the Duckb C API and should be compatible with duckb v1.2.0+</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build extension (uses package's bundled htslib)</span></span>
<span><span class="va">build_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"bcf_reader"</span><span class="op">)</span></span>
<span><span class="va">ext_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/bcf_reader_build.html">bcf_reader_build</a></span><span class="op">(</span><span class="va">build_dir</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Connect and query a VCF.gz file</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_duckdb_connect.html">vcf_duckdb_connect</a></span><span class="op">(</span><span class="va">ext_path</span><span class="op">)</span></span>
<span><span class="va">vcf_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"test_deep_variant.vcf.gz"</span>, package <span class="op">=</span> <span class="st">"RBCFTools"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Describe schema</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"DESCRIBE SELECT * FROM bcf_read('%s')"</span>, <span class="va">vcf_file</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                        column_name column_type null  key default extra</span></span>
<span><span class="co">#&gt; 1                            CHROM     VARCHAR  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2                              POS      BIGINT  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3                               ID     VARCHAR  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4                              REF     VARCHAR  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5                              ALT   VARCHAR[]  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 6                             QUAL      DOUBLE  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 7                           FILTER   VARCHAR[]  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 8                         INFO_END     INTEGER  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 9      FORMAT_GT_test_deep_variant     VARCHAR  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 10     FORMAT_GQ_test_deep_variant     INTEGER  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 11     FORMAT_DP_test_deep_variant     INTEGER  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 12 FORMAT_MIN_DP_test_deep_variant     INTEGER  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 13     FORMAT_AD_test_deep_variant   INTEGER[]  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 14    FORMAT_VAF_test_deep_variant     FLOAT[]  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 15     FORMAT_PL_test_deep_variant   INTEGER[]  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 16 FORMAT_MED_DP_test_deep_variant     INTEGER  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span></span>
<span><span class="co"># Aggregate query</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">  SELECT CHROM, COUNT(*) as n_variants, </span></span>
<span><span class="st">         MIN(POS) as min_pos, MAX(POS) as max_pos</span></span>
<span><span class="st">  FROM bcf_read('%s') </span></span>
<span><span class="st">  GROUP BY CHROM </span></span>
<span><span class="st">  ORDER BY n_variants DESC </span></span>
<span><span class="st">  LIMIT 5"</span>, <span class="va">vcf_file</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM n_variants min_pos   max_pos</span></span>
<span><span class="co">#&gt; 1    19      35918  111129  59084689</span></span>
<span><span class="co">#&gt; 2     1      35846  536895 249211717</span></span>
<span><span class="co">#&gt; 3    17      27325    6102  81052229</span></span>
<span><span class="co">#&gt; 4    11      24472  180184 134257519</span></span>
<span><span class="co">#&gt; 5     2      22032   42993 242836470</span></span>
<span></span>
<span><span class="co"># Export directly to Parquet</span></span>
<span><span class="va">parquet_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>fileext <span class="op">=</span> <span class="st">".parquet"</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">  COPY (SELECT * FROM bcf_read('%s')) </span></span>
<span><span class="st">  TO '%s' (FORMAT PARQUET, COMPRESSION ZSTD)"</span>, <span class="va">vcf_file</span>, <span class="va">parquet_out</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 368319</span></span>
<span></span>
<span><span class="co"># Verify parquet file size</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="va">parquet_out</span><span class="op">)</span><span class="op">$</span><span class="va">size</span></span>
<span><span class="co">#&gt; [1] 3998815</span></span>
<span></span>
<span><span class="co"># Same query on Parquet file</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"</span></span>
<span><span class="st">  SELECT CHROM, COUNT(*) as n_variants, </span></span>
<span><span class="st">         MIN(POS) as min_pos, MAX(POS) as max_pos</span></span>
<span><span class="st">  FROM '%s' </span></span>
<span><span class="st">  GROUP BY CHROM </span></span>
<span><span class="st">  ORDER BY n_variants DESC </span></span>
<span><span class="st">  LIMIT 5"</span>, <span class="va">parquet_out</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM n_variants min_pos   max_pos</span></span>
<span><span class="co">#&gt; 1    19      35918  111129  59084689</span></span>
<span><span class="co">#&gt; 2     1      35846  536895 249211717</span></span>
<span><span class="co">#&gt; 3    17      27325    6102  81052229</span></span>
<span><span class="co">#&gt; 4    11      24472  180184 134257519</span></span>
<span><span class="co">#&gt; 5     2      22032   42993 242836470</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="stream-remote-vcf-using-arrow-or-duckdb-extension">Stream Remote VCF using Arrow or DuckDB Extension<a class="anchor" aria-label="anchor" href="#stream-remote-vcf-using-arrow-or-duckdb-extension"></a>
</h3>
<p>Stream remote VCF region directly from S3 using either <code>nanoarrow</code> based <code>vcf_stream</code> or <code>duckb</code> extension</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s3_vcf_uri</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">s3_base</span>, <span class="va">s3_path</span>, <span class="va">s3_vcf_file</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Arrow stream</span></span>
<span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_open_arrow.html">vcf_open_arrow</a></span><span class="op">(</span></span>
<span>    <span class="va">s3_vcf_uri</span>,</span>
<span>    region <span class="op">=</span> <span class="st">"chr22:16050000-16050500"</span>,</span>
<span>    batch_size <span class="op">=</span> <span class="fl">1000L</span></span>
<span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">nanoarrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/nanoarrow/latest/r/reference/convert_array_stream.html" class="external-link">convert_array_stream</a></span><span class="op">(</span><span class="va">stream</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span>, <span class="st">"ALT"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM      POS REF                  ALT</span></span>
<span><span class="co">#&gt; 1 chr22 16050036   A C        , &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 2 chr22 16050151   T G        , &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 3 chr22 16050213   C T        , &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 4 chr22 16050219   C A        , &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 5 chr22 16050224   A C        , &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 6 chr22 16050229   C A        , &lt;NON_REF&gt;</span></span>
<span></span>
<span></span>
<span><span class="co"># Query remote VCF with bcf_reader extension</span></span>
<span></span>
<span><span class="fu"><a href="reference/vcf_query_duckdb.html">vcf_query_duckdb</a></span><span class="op">(</span></span>
<span>    <span class="va">s3_vcf_uri</span>,</span>
<span>    <span class="va">ext_path</span>,</span>
<span>    region <span class="op">=</span> <span class="st">"chr22:16050000-16050500"</span>,</span>
<span>    query <span class="op">=</span> <span class="st">"SELECT CHROM, POS, REF, ALT FROM vcf LIMIT 5"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM      POS REF          ALT</span></span>
<span><span class="co">#&gt; 1 chr22 16050036   A C, &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 2 chr22 16050151   T G, &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 3 chr22 16050213   C T, &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 4 chr22 16050219   C A, &lt;NON_REF&gt;</span></span>
<span><span class="co">#&gt; 5 chr22 16050224   A C, &lt;NON_REF&gt;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="command-line-tool">Command-Line Tool<a class="anchor" aria-label="anchor" href="#command-line-tool"></a>
</h3>
<p>A CLI tool is provided for VCF to Parquet conversion and querying, including threaded chunking based on contigs</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># Get paths using system.file</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="va">SCRIPT</span><span class="op">=</span><span class="va">$(</span><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"cat(system.file('scripts', 'vcf2parquet.R', package='RBCFTools'))"</span><span class="va">)</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="va">BCF</span><span class="op">=</span><span class="va">$(</span><span class="ex">Rscript</span> <span class="at">-e</span> <span class="st">"cat(system.file('extdata', '1000G_3samples.bcf', package='RBCFTools'))"</span><span class="va">)</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="va">OUT_PQ</span><span class="op">=</span><span class="va">$(</span><span class="fu">mktemp</span> <span class="at">--suffix</span><span class="op">=</span>.parquet<span class="va">)</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co"># Convert BCF to Parquet</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="va">$SCRIPT</span> convert <span class="at">--quiet</span> <span class="at">-i</span> <span class="va">$BCF</span> <span class="at">-o</span> <span class="va">$OUT_PQ</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="co"># Query with DuckDB SQL</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="va">$SCRIPT</span> query <span class="at">-i</span> <span class="va">$OUT_PQ</span> <span class="at">-q</span> <span class="st">"SELECT CHROM, POS, REF, ALT FROM parquet_scan('</span><span class="va">$OUT_PQ</span><span class="st">') LIMIT 5"</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="co"># Describe table structure</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="va">$SCRIPT</span> query <span class="at">-i</span> <span class="va">$OUT_PQ</span> <span class="at">-q</span> <span class="st">"DESCRIBE SELECT * FROM parquet_scan('</span><span class="va">$OUT_PQ</span><span class="st">')"</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="co"># Show schema</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="va">$SCRIPT</span> schema 0 <span class="at">--quiet</span> <span class="at">-i</span> <span class="va">$BCF</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co"># File info</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="va">$SCRIPT</span> info <span class="at">-i</span> <span class="va">$OUT_PQ</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-f</span> <span class="va">$OUT_PQ</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="co">#&gt; Converting VCF to Parquet...</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="co">#&gt;   Input: /usr/lib64/R/library/RBCFTools/extdata/1000G_3samples.bcf </span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="co">#&gt;   Output: /tmp/tmp.cV4aK1aH05.parquet </span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="co">#&gt;   Compression: zstd </span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="co">#&gt;   Batch size: 10000 </span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="co">#&gt;   Threads: 1 </span></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a><span class="co">#&gt;   Streaming: FALSE </span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a><span class="co">#&gt;   Include INFO: TRUE </span></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a><span class="co">#&gt;   Include FORMAT: TRUE </span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="co">#&gt; [W::bcf_hdr_check_sanity] AD should be declared as Number=R</span></span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a><span class="co">#&gt; [W::bcf_hdr_check_sanity] GQ should be declared as Type=Integer</span></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a><span class="co">#&gt; [W::bcf_hdr_check_sanity] GT should be declared as Number=1</span></span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a><span class="co">#&gt; Wrote 11 rows to /tmp/tmp.cV4aK1aH05.parquet</span></span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a><span class="co">#&gt; ✓ Conversion complete!</span></span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a><span class="co">#&gt;   Time: 0.50 seconds</span></span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a><span class="co">#&gt;   Output size: 0.01 MB</span></span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a><span class="co">#&gt; Running query on Parquet file(s)...</span></span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a><span class="co">#&gt;   CHROM   POS REF ALT</span></span>
<span id="cb15-41"><a href="#cb15-41" tabindex="-1"></a><span class="co">#&gt; 1     1 10583   G   A</span></span>
<span id="cb15-42"><a href="#cb15-42" tabindex="-1"></a><span class="co">#&gt; 2     1 11508   A   G</span></span>
<span id="cb15-43"><a href="#cb15-43" tabindex="-1"></a><span class="co">#&gt; 3     1 11565   G   T</span></span>
<span id="cb15-44"><a href="#cb15-44" tabindex="-1"></a><span class="co">#&gt; 4     1 13116   T   G</span></span>
<span id="cb15-45"><a href="#cb15-45" tabindex="-1"></a><span class="co">#&gt; 5     1 13327   G   C</span></span>
<span id="cb15-46"><a href="#cb15-46" tabindex="-1"></a><span class="co">#&gt; Running query on Parquet file(s)...</span></span>
<span id="cb15-47"><a href="#cb15-47" tabindex="-1"></a><span class="co">#&gt;   column_name</span></span>
<span id="cb15-48"><a href="#cb15-48" tabindex="-1"></a><span class="co">#&gt; 1       CHROM</span></span>
<span id="cb15-49"><a href="#cb15-49" tabindex="-1"></a><span class="co">#&gt; 2         POS</span></span>
<span id="cb15-50"><a href="#cb15-50" tabindex="-1"></a><span class="co">#&gt; 3          ID</span></span>
<span id="cb15-51"><a href="#cb15-51" tabindex="-1"></a><span class="co">#&gt; 4         REF</span></span>
<span id="cb15-52"><a href="#cb15-52" tabindex="-1"></a><span class="co">#&gt; 5         ALT</span></span>
<span id="cb15-53"><a href="#cb15-53" tabindex="-1"></a><span class="co">#&gt; 6        QUAL</span></span>
<span id="cb15-54"><a href="#cb15-54" tabindex="-1"></a><span class="co">#&gt; 7      FILTER</span></span>
<span id="cb15-55"><a href="#cb15-55" tabindex="-1"></a><span class="co">#&gt; 8        INFO</span></span>
<span id="cb15-56"><a href="#cb15-56" tabindex="-1"></a><span class="co">#&gt; 9     samples</span></span>
<span id="cb15-57"><a href="#cb15-57" tabindex="-1"></a><span class="co">#&gt;                                                                                                                                                                                                                                                                                                    column_type</span></span>
<span id="cb15-58"><a href="#cb15-58" tabindex="-1"></a><span class="co">#&gt; 1                                                                                                                                                                                                                                                                                                      VARCHAR</span></span>
<span id="cb15-59"><a href="#cb15-59" tabindex="-1"></a><span class="co">#&gt; 2                                                                                                                                                                                                                                                                                                       DOUBLE</span></span>
<span id="cb15-60"><a href="#cb15-60" tabindex="-1"></a><span class="co">#&gt; 3                                                                                                                                                                                                                                                                                                      VARCHAR</span></span>
<span id="cb15-61"><a href="#cb15-61" tabindex="-1"></a><span class="co">#&gt; 4                                                                                                                                                                                                                                                                                                      VARCHAR</span></span>
<span id="cb15-62"><a href="#cb15-62" tabindex="-1"></a><span class="co">#&gt; 5                                                                                                                                                                                                                                                                                                    VARCHAR[]</span></span>
<span id="cb15-63"><a href="#cb15-63" tabindex="-1"></a><span class="co">#&gt; 6                                                                                                                                                                                                                                                                                                       DOUBLE</span></span>
<span id="cb15-64"><a href="#cb15-64" tabindex="-1"></a><span class="co">#&gt; 7                                                                                                                                                                                                                                                                                                    VARCHAR[]</span></span>
<span id="cb15-65"><a href="#cb15-65" tabindex="-1"></a><span class="co">#&gt; 8                                                                                                                                                                                         STRUCT(DP INTEGER, AF DOUBLE[], CB VARCHAR[], EUR_R2 DOUBLE, AFR_R2 DOUBLE, ASN_R2 DOUBLE, AC INTEGER[], AN INTEGER)</span></span>
<span id="cb15-66"><a href="#cb15-66" tabindex="-1"></a><span class="co">#&gt; 9 STRUCT(HG00098 STRUCT(AD BLOB, DP INTEGER, GL BLOB, GQ DOUBLE, GT VARCHAR, GD DOUBLE, OG VARCHAR), HG00100 STRUCT(AD INTEGER[], DP INTEGER, GL DOUBLE[], GQ DOUBLE, GT VARCHAR, GD DOUBLE, OG VARCHAR), HG00106 STRUCT(AD INTEGER[], DP INTEGER, GL DOUBLE[], GQ DOUBLE, GT VARCHAR, GD DOUBLE, OG VARCHAR))</span></span>
<span id="cb15-67"><a href="#cb15-67" tabindex="-1"></a><span class="co">#&gt;   null  key default extra</span></span>
<span id="cb15-68"><a href="#cb15-68" tabindex="-1"></a><span class="co">#&gt; 1  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span id="cb15-69"><a href="#cb15-69" tabindex="-1"></a><span class="co">#&gt; 2  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span id="cb15-70"><a href="#cb15-70" tabindex="-1"></a><span class="co">#&gt; 3  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span id="cb15-71"><a href="#cb15-71" tabindex="-1"></a><span class="co">#&gt; 4  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span id="cb15-72"><a href="#cb15-72" tabindex="-1"></a><span class="co">#&gt; 5  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span id="cb15-73"><a href="#cb15-73" tabindex="-1"></a><span class="co">#&gt; 6  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span id="cb15-74"><a href="#cb15-74" tabindex="-1"></a><span class="co">#&gt; 7  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span id="cb15-75"><a href="#cb15-75" tabindex="-1"></a><span class="co">#&gt; 8  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span id="cb15-76"><a href="#cb15-76" tabindex="-1"></a><span class="co">#&gt; 9  YES &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;</span></span>
<span id="cb15-77"><a href="#cb15-77" tabindex="-1"></a><span class="co">#&gt; Unknown option: 0 </span></span>
<span id="cb15-78"><a href="#cb15-78" tabindex="-1"></a><span class="co">#&gt; Parquet File Information: /tmp/tmp.cV4aK1aH05.parquet </span></span>
<span id="cb15-79"><a href="#cb15-79" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-80"><a href="#cb15-80" tabindex="-1"></a><span class="co">#&gt; File size: 0.01 MB </span></span>
<span id="cb15-81"><a href="#cb15-81" tabindex="-1"></a><span class="co">#&gt; Total rows: 11 </span></span>
<span id="cb15-82"><a href="#cb15-82" tabindex="-1"></a><span class="co">#&gt; Number of columns: 60 </span></span>
<span id="cb15-83"><a href="#cb15-83" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb15-84"><a href="#cb15-84" tabindex="-1"></a><span class="co">#&gt; Schema (top-level columns):</span></span>
<span id="cb15-85"><a href="#cb15-85" tabindex="-1"></a><span class="co">#&gt;     name       type</span></span>
<span id="cb15-86"><a href="#cb15-86" tabindex="-1"></a><span class="co">#&gt;    CHROM BYTE_ARRAY</span></span>
<span id="cb15-87"><a href="#cb15-87" tabindex="-1"></a><span class="co">#&gt;      POS     DOUBLE</span></span>
<span id="cb15-88"><a href="#cb15-88" tabindex="-1"></a><span class="co">#&gt;       ID BYTE_ARRAY</span></span>
<span id="cb15-89"><a href="#cb15-89" tabindex="-1"></a><span class="co">#&gt;      REF BYTE_ARRAY</span></span>
<span id="cb15-90"><a href="#cb15-90" tabindex="-1"></a><span class="co">#&gt;      ALT       &lt;NA&gt;</span></span>
<span id="cb15-91"><a href="#cb15-91" tabindex="-1"></a><span class="co">#&gt;     QUAL     DOUBLE</span></span>
<span id="cb15-92"><a href="#cb15-92" tabindex="-1"></a><span class="co">#&gt;   FILTER       &lt;NA&gt;</span></span>
<span id="cb15-93"><a href="#cb15-93" tabindex="-1"></a><span class="co">#&gt;     INFO       &lt;NA&gt;</span></span>
<span id="cb15-94"><a href="#cb15-94" tabindex="-1"></a><span class="co">#&gt;       DP      INT32</span></span>
<span id="cb15-95"><a href="#cb15-95" tabindex="-1"></a><span class="co">#&gt;       AF       &lt;NA&gt;</span></span>
<span id="cb15-96"><a href="#cb15-96" tabindex="-1"></a><span class="co">#&gt;       CB       &lt;NA&gt;</span></span>
<span id="cb15-97"><a href="#cb15-97" tabindex="-1"></a><span class="co">#&gt;   EUR_R2     DOUBLE</span></span>
<span id="cb15-98"><a href="#cb15-98" tabindex="-1"></a><span class="co">#&gt;   AFR_R2     DOUBLE</span></span>
<span id="cb15-99"><a href="#cb15-99" tabindex="-1"></a><span class="co">#&gt;   ASN_R2     DOUBLE</span></span>
<span id="cb15-100"><a href="#cb15-100" tabindex="-1"></a><span class="co">#&gt;       AC       &lt;NA&gt;</span></span>
<span id="cb15-101"><a href="#cb15-101" tabindex="-1"></a><span class="co">#&gt;       AN      INT32</span></span>
<span id="cb15-102"><a href="#cb15-102" tabindex="-1"></a><span class="co">#&gt;  samples       &lt;NA&gt;</span></span>
<span id="cb15-103"><a href="#cb15-103" tabindex="-1"></a><span class="co">#&gt;  HG00098       &lt;NA&gt;</span></span>
<span id="cb15-104"><a href="#cb15-104" tabindex="-1"></a><span class="co">#&gt;       AD BYTE_ARRAY</span></span>
<span id="cb15-105"><a href="#cb15-105" tabindex="-1"></a><span class="co">#&gt;       DP      INT32</span></span>
<span id="cb15-106"><a href="#cb15-106" tabindex="-1"></a><span class="co">#&gt;       GL BYTE_ARRAY</span></span>
<span id="cb15-107"><a href="#cb15-107" tabindex="-1"></a><span class="co">#&gt;       GQ     DOUBLE</span></span>
<span id="cb15-108"><a href="#cb15-108" tabindex="-1"></a><span class="co">#&gt;       GT BYTE_ARRAY</span></span>
<span id="cb15-109"><a href="#cb15-109" tabindex="-1"></a><span class="co">#&gt;       GD     DOUBLE</span></span>
<span id="cb15-110"><a href="#cb15-110" tabindex="-1"></a><span class="co">#&gt;       OG BYTE_ARRAY</span></span>
<span id="cb15-111"><a href="#cb15-111" tabindex="-1"></a><span class="co">#&gt;  HG00100       &lt;NA&gt;</span></span>
<span id="cb15-112"><a href="#cb15-112" tabindex="-1"></a><span class="co">#&gt;       AD       &lt;NA&gt;</span></span>
<span id="cb15-113"><a href="#cb15-113" tabindex="-1"></a><span class="co">#&gt;       DP      INT32</span></span>
<span id="cb15-114"><a href="#cb15-114" tabindex="-1"></a><span class="co">#&gt;       GL       &lt;NA&gt;</span></span>
<span id="cb15-115"><a href="#cb15-115" tabindex="-1"></a><span class="co">#&gt;       GQ     DOUBLE</span></span>
<span id="cb15-116"><a href="#cb15-116" tabindex="-1"></a><span class="co">#&gt;       GT BYTE_ARRAY</span></span>
<span id="cb15-117"><a href="#cb15-117" tabindex="-1"></a><span class="co">#&gt;       GD     DOUBLE</span></span>
<span id="cb15-118"><a href="#cb15-118" tabindex="-1"></a><span class="co">#&gt;       OG BYTE_ARRAY</span></span>
<span id="cb15-119"><a href="#cb15-119" tabindex="-1"></a><span class="co">#&gt;  HG00106       &lt;NA&gt;</span></span>
<span id="cb15-120"><a href="#cb15-120" tabindex="-1"></a><span class="co">#&gt;       AD       &lt;NA&gt;</span></span>
<span id="cb15-121"><a href="#cb15-121" tabindex="-1"></a><span class="co">#&gt;       DP      INT32</span></span>
<span id="cb15-122"><a href="#cb15-122" tabindex="-1"></a><span class="co">#&gt;       GL       &lt;NA&gt;</span></span>
<span id="cb15-123"><a href="#cb15-123" tabindex="-1"></a><span class="co">#&gt;       GQ     DOUBLE</span></span>
<span id="cb15-124"><a href="#cb15-124" tabindex="-1"></a><span class="co">#&gt;       GT BYTE_ARRAY</span></span>
<span id="cb15-125"><a href="#cb15-125" tabindex="-1"></a><span class="co">#&gt;       GD     DOUBLE</span></span>
<span id="cb15-126"><a href="#cb15-126" tabindex="-1"></a><span class="co">#&gt;       OG BYTE_ARRAY</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-index-file-path">Custom Index File Path<a class="anchor" aria-label="anchor" href="#custom-index-file-path"></a>
</h3>
<p>For region queries, an index file is required. By default, RBCFTools looks for <code>.tbi</code> (tabix) or <code>.csi</code> indexes using standard naming conventions. For non-standard index locations such as presigned URLs or custom paths, use the <code>index</code> parameter. Index files are only required for region queries; when reading an entire file without a region filter, no index is needed. VCF files try <code>.tbi</code> first then fall back to <code>.csi</code>, while BCF files use <code>.csi</code> only.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Explicit index file path</span></span>
<span><span class="va">bcf_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"1000G_3samples.bcf"</span>, package <span class="op">=</span> <span class="st">"RBCFTools"</span><span class="op">)</span></span>
<span><span class="va">csi_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"1000G_3samples.bcf.csi"</span>, package <span class="op">=</span> <span class="st">"RBCFTools"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">stream</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_open_arrow.html">vcf_open_arrow</a></span><span class="op">(</span><span class="va">bcf_file</span>, index <span class="op">=</span> <span class="va">csi_index</span><span class="op">)</span></span>
<span><span class="va">batch</span> <span class="op">&lt;-</span> <span class="va">stream</span><span class="op">$</span><span class="fu">get_next</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">nanoarrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/nanoarrow/latest/r/reference/convert_array.html" class="external-link">convert_array</a></span><span class="op">(</span><span class="va">batch</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF</span></span>
<span><span class="co">#&gt; 1     1 10583   G</span></span>
<span><span class="co">#&gt; 2     1 11508   A</span></span>
<span><span class="co">#&gt; 3     1 11565   G</span></span>
<span></span>
<span><span class="co"># Alternative: htslib ##idx## syntax in filename</span></span>
<span><span class="va">filename_with_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">bcf_file</span>, <span class="st">"##idx##"</span>, <span class="va">csi_index</span><span class="op">)</span></span>
<span><span class="va">stream2</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/vcf_open_arrow.html">vcf_open_arrow</a></span><span class="op">(</span><span class="va">filename_with_idx</span><span class="op">)</span></span>
<span><span class="va">batch2</span> <span class="op">&lt;-</span> <span class="va">stream2</span><span class="op">$</span><span class="fu">get_next</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">nanoarrow</span><span class="fu">::</span><span class="fu"><a href="https://arrow.apache.org/nanoarrow/latest/r/reference/convert_array.html" class="external-link">convert_array</a></span><span class="op">(</span><span class="va">batch2</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CHROM"</span>, <span class="st">"POS"</span>, <span class="st">"REF"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;   CHROM   POS REF</span></span>
<span><span class="co">#&gt; 1     1 10583   G</span></span>
<span><span class="co">#&gt; 2     1 11508   A</span></span>
<span><span class="co">#&gt; 3     1 11565   G</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="limitations-and-issues">Limitations and issues<a class="anchor" aria-label="anchor" href="#limitations-and-issues"></a>
</h2>
<ul>
<li>Arrow stream still copies at the C level and again on Parquet conversion (Arrow IPC serialization); optimizing zero-copy paths remains open.</li>
<li>VEP/CSQ/BCSQ/ANN: DuckDB extension now parses INFO/CSQ|BCSQ|ANN into typed <code>VEP_*</code> columns with all transcripts preserved as lists. Arrow stream parsing exists but is still being hardened/aligned.</li>
<li>Remaining structured annotation formats (e.g., SnpEff extras) are not parsed beyond VCF header types.</li>
</ul>
</div>
<div class="section level2">
<h2 id="future-directions">Future directions<a class="anchor" aria-label="anchor" href="#future-directions"></a>
</h2>
<p>We should improve the code, avoid copies, add more tests and maybe <a href="https://github.com/duckdb/ducklake" class="external-link">ducklake</a> support</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li><p><a href="https://samtools.github.io/bcftools/" class="external-link">bcftools documentation</a></p></li>
<li><p><a href="https://github.com/samtools/bcftools" class="external-link">bcftools GitHub</a></p></li>
<li><p><a href="https://github.com/samtools/htslib" class="external-link">htslib GitHub</a></p></li>
<li><p><a href="https://arrow.apache.org/nanoarrow/" class="external-link">arrow-nanoarrow</a></p></li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/RGenomicsETL/RBCFTools/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/RGenomicsETL/RBCFTools/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 3)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing RBCFTools</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Sounkou Mahamane Toure <br><small class="roles"> Author, maintainer </small>   </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/RGenomicsETL/RBCFTools/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/RGenomicsETL/RBCFTools/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://RGenomicsETL.r-universe.dev/RBCFTools" class="external-link"><img src="https://RGenomicsETL.r-universe.dev/RBCFTools/badges/version" alt="R-universe version"></a></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sounkou Mahamane Toure.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
