<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Load VCF into DuckLake (ETL + Registration) — ducklake_load_vcf • RBCFTools</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Load VCF into DuckLake (ETL + Registration) — ducklake_load_vcf"><meta name="description" content="Converts VCF/BCF to Parquet using the fast bcf_reader extension, then
registers the Parquet file in a DuckLake catalog table."><meta property="og:description" content="Converts VCF/BCF to Parquet using the fast bcf_reader extension, then
registers the Parquet file in a DuckLake catalog table."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">RBCFTools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.23-0.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/RGenomicsETL/RBCFTools/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Load VCF into DuckLake (ETL + Registration)</h1>
      <small class="dont-index">Source: <a href="https://github.com/RGenomicsETL/RBCFTools/blob/main/R/ducklake.R" class="external-link"><code>R/ducklake.R</code></a></small>
      <div class="d-none name"><code>ducklake_load_vcf.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Converts VCF/BCF to Parquet using the fast <code>bcf_reader</code> extension, then
registers the Parquet file in a DuckLake catalog table.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">ducklake_load_vcf</span><span class="op">(</span></span>
<span>  <span class="va">con</span>,</span>
<span>  <span class="va">table</span>,</span>
<span>  <span class="va">vcf_path</span>,</span>
<span>  <span class="va">extension_path</span>,</span>
<span>  output_path <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  threads <span class="op">=</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  compression <span class="op">=</span> <span class="st">"zstd"</span>,</span>
<span>  row_group_size <span class="op">=</span> <span class="fl">100000L</span>,</span>
<span>  region <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  columns <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  overwrite <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  allow_evolution <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  tidy_format <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  partition_by <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-con">con<a class="anchor" aria-label="anchor" href="#arg-con"></a></dt>
<dd><p>DuckDB connection with DuckLake attached.</p></dd>


<dt id="arg-table">table<a class="anchor" aria-label="anchor" href="#arg-table"></a></dt>
<dd><p>Target table name (optionally qualified, e.g., "lake.variants").</p></dd>


<dt id="arg-vcf-path">vcf_path<a class="anchor" aria-label="anchor" href="#arg-vcf-path"></a></dt>
<dd><p>Path/URI to VCF/BCF file.</p></dd>


<dt id="arg-extension-path">extension_path<a class="anchor" aria-label="anchor" href="#arg-extension-path"></a></dt>
<dd><p>Path to bcf_reader.duckdb_extension (required).</p></dd>


<dt id="arg-output-path">output_path<a class="anchor" aria-label="anchor" href="#arg-output-path"></a></dt>
<dd><p>Optional Parquet output path. If NULL, uses DuckLake's DATA_PATH.</p></dd>


<dt id="arg-threads">threads<a class="anchor" aria-label="anchor" href="#arg-threads"></a></dt>
<dd><p>Number of threads for conversion.</p></dd>


<dt id="arg-compression">compression<a class="anchor" aria-label="anchor" href="#arg-compression"></a></dt>
<dd><p>Parquet compression codec.</p></dd>


<dt id="arg-row-group-size">row_group_size<a class="anchor" aria-label="anchor" href="#arg-row-group-size"></a></dt>
<dd><p>Parquet row group size.</p></dd>


<dt id="arg-region">region<a class="anchor" aria-label="anchor" href="#arg-region"></a></dt>
<dd><p>Optional region filter (e.g., "chr1:1000-2000").</p></dd>


<dt id="arg-columns">columns<a class="anchor" aria-label="anchor" href="#arg-columns"></a></dt>
<dd><p>Optional character vector of columns to include.</p></dd>


<dt id="arg-overwrite">overwrite<a class="anchor" aria-label="anchor" href="#arg-overwrite"></a></dt>
<dd><p>Logical, drop existing table first.</p></dd>


<dt id="arg-allow-evolution">allow_evolution<a class="anchor" aria-label="anchor" href="#arg-allow-evolution"></a></dt>
<dd><p>Logical, evolve table schema by adding new columns from VCF.
Default: FALSE. When TRUE, new columns found in the VCF are added via ALTER TABLE
before insertion, making all columns queryable. Useful for combining VCFs with
different annotations (e.g., VEP columns) or different samples (FORMAT_*_SampleName).</p></dd>


<dt id="arg-tidy-format">tidy_format<a class="anchor" aria-label="anchor" href="#arg-tidy-format"></a></dt>
<dd><p>Logical, if TRUE exports data in tidy (long) format with one
row per variant-sample combination and a SAMPLE_ID column. Default FALSE.
Ideal for cohort analysis and combining multiple single-sample VCFs.</p></dd>


<dt id="arg-partition-by">partition_by<a class="anchor" aria-label="anchor" href="#arg-partition-by"></a></dt>
<dd><p>Optional character vector of columns to partition by (Hive-style).
Creates directory structure like <code>output_dir/SAMPLE_ID=HG00098/data_0.parquet</code>.
Note: DuckLake registration currently requires single Parquet files; when using
partition_by, the output_path should point to the partition directory and
files should be registered separately.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>Invisibly returns the path to the created Parquet file.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This is the recommended function for loading VCF data into DuckLake.
It uses the <code>bcf_reader</code> DuckDB extension for fast VCF→Parquet conversion,
which is significantly faster than the nanoarrow streaming path.</p>
<p><strong>Workflow:</strong></p><ol><li><p>VCF → Parquet via <code><a href="vcf_to_parquet_duckdb.html">vcf_to_parquet_duckdb()</a></code> (bcf_reader)</p></li>
<li><p>Register Parquet in DuckLake catalog</p></li>
</ol><p><strong>Schema Evolution (<code>allow_evolution = TRUE</code>):</strong>
When loading multiple VCFs with different schemas (e.g., different samples
or different annotation fields), enable <code>allow_evolution</code> to automatically
add new columns to the table schema. This uses DuckLake's <code>ALTER TABLE ADD COLUMN</code>
which preserves existing data files without rewriting.</p>
<p><strong>Tidy Format (<code>tidy_format = TRUE</code>):</strong>
When building cohort tables from multiple single-sample VCFs, use <code>tidy_format = TRUE</code>
to get one row per variant-sample combination with a <code>SAMPLE_ID</code> column. This format
is ideal for downstream analysis and MERGE/UPSERT operations on DuckLake tables.</p>
<p><strong>Partitioning (<code>partition_by</code>):</strong>
When using <code>partition_by</code>, the output is a Hive-partitioned directory structure.
This is useful for large cohorts where you want efficient per-sample queries.
DuckDB auto-generates Bloom filters for VARCHAR columns like SAMPLE_ID.
Note: For DuckLake, partitioned output requires manual file registration.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Build extension</span></span></span>
<span class="r-in"><span><span class="va">ext_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="bcf_reader_build.html">bcf_reader_build</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Setup DuckLake</span></span></span>
<span class="r-in"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">duckdb</span><span class="fu">::</span><span class="fu">dbConnect</span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="ducklake_load.html">ducklake_load</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="ducklake_attach.html">ducklake_attach</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"catalog.ducklake"</span>, <span class="st">"/data/parquet/"</span>, alias <span class="op">=</span> <span class="st">"lake"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"USE lake"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Load first VCF</span></span></span>
<span class="r-in"><span><span class="fu">ducklake_load_vcf</span><span class="op">(</span><span class="va">con</span>, <span class="st">"variants"</span>, <span class="st">"sample1.vcf.gz"</span>, <span class="va">ext_path</span>, threads <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Load second VCF with different annotations, evolving schema</span></span></span>
<span class="r-in"><span><span class="fu">ducklake_load_vcf</span><span class="op">(</span><span class="va">con</span>, <span class="st">"variants"</span>, <span class="st">"sample2_vep.vcf.gz"</span>, <span class="va">ext_path</span>,</span></span>
<span class="r-in"><span>  allow_evolution <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Load VCF in tidy format (one row per variant-sample)</span></span></span>
<span class="r-in"><span><span class="fu">ducklake_load_vcf</span><span class="op">(</span><span class="va">con</span>, <span class="st">"variants_tidy"</span>, <span class="st">"cohort.vcf.gz"</span>, <span class="va">ext_path</span>,</span></span>
<span class="r-in"><span>  tidy_format <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Query - all columns from both VCFs are available</span></span></span>
<span class="r-in"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"SELECT CHROM, COUNT(*) FROM variants GROUP BY CHROM"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sounkou Mahamane Toure.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

