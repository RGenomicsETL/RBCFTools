#!/bin/sh
# copied mainly  from https://github.com/Zilong-Li/vcfppR/blob/main/configure 
# And https://github.com/sounkou-bioinfo/bcflib/blob/main/src/Makevars
set -eu
THISDir=`dirname $0`
THISDir=`realpath ${THISDir}`

# Capture configure arguments (--host, --build, etc.)
CONFIGURE_ARGS="$@"

MAKE=`"${R_HOME}/bin/R" CMD config MAKE`
CC=`"${R_HOME}/bin/R" CMD config CC`
AR=`"${R_HOME}/bin/R" CMD config AR`
RANLIB=`"${R_HOME}/bin/R" CMD config RANLIB`
R_CPPFLAGS=`"${R_HOME}/bin/R" CMD config CPPFLAGS`
R_CFLAGS=`"${R_HOME}/bin/R" CMD config CFLAGS`
R_CPICFLAGS=`"${R_HOME}/bin/R" CMD config CPICFLAGS`
R_LDFLAGS=`"${R_HOME}/bin/R" CMD config LDFLAGS`
HTSLIB_BUNDLED_MK=${THISDir}/inst/makefiles/htscodecs_bundled.mk
RSCRIPT="${R_HOME}/bin/Rscript"
hstlibversion="1.23"
#--- get shared library extension
if [ "$(uname)" = "Darwin" ]; then
     SHLIB_EXT="dylib"
else
     SHLIB_EXT="so"
fi
# CFLAGS="${R_CFLAGS} ${R_CPICFLAGS} -fPIC -D_FILE_OFFSET_BITS=64"
CFLAGS="-Wall -g -O2 -fPIC -D_FILE_OFFSET_BITS=64"
# remove assert by defining NDEBUG
CPPFLAGS="${R_CPPFLAGS} -DNDEBUG"
LDFLAGS="${R_LDFLAGS}"
HTSLIB_DIR="${THISDir}/src/bcftools-${hstlibversion}/htslib-${hstlibversion}"
HTS_FILE_ARCHIVE="${THISDir}/src/bcftools-${hstlibversion}/libhts.a"
HTS_FILE_SO="${THISDir}/src/bcftools-${hstlibversion}/libhts.${SHLIB_EXT}"
BCFTOOLS_DIR="${THISDir}/src/bcftools-${hstlibversion}"
#--------------------- Check for GSL
HAVE_GSL="no"
USE_GPL=""
GSL_LIBS=""
GSL_CFLAGS=""
#----------------- Check for CHOLMOD 
HAVE_CHOLMOD="no"
CHOLMOD_CPPFLAGS=""
CHOLMOD_LIBS=""

if command -v gsl-config >/dev/null 2>&1; then
  echo "Found GSL via gsl-config"
  echo "GSL version: $(gsl-config --version)"
  echo "GSL libs: $(gsl-config --libs)"
  echo "GSL cflags: $(gsl-config --cflags)"
  # Test if we can actually link against the same GSL function that bcftools tests for
  echo "Testing if gsl_multifit_gradient function is available..."
  if echo 'char gsl_multifit_gradient (void);
int main (void) { 
  return gsl_multifit_gradient (); 
}' | \
     ${CC} ${CFLAGS} $(gsl-config --cflags) -x c - -lgsl -lgslcblas -lm -o /dev/null 2>/dev/null; then
    HAVE_GSL="yes"
    USE_GPL="1"
    GSL_LIBS=$(gsl-config --libs)
    GSL_CFLAGS=$(gsl-config --cflags)
    # Add -DUSE_GSL to CPPFLAGS when GSL is available
    CPPFLAGS="${CPPFLAGS} -DUSE_GSL ${GSL_CFLAGS}"
    echo "GSL linking test passed - polysomy functionality will be enabled"
  else
    echo "GSL found but linking test failed - polysomy functionality will be disabled"
    echo "This may be due to GSL version incompatibility (GSL 2.x removes gsl_multifit_gradient)"
    echo "Either configure with --disable-libgsl or resolve this error to build bcftools."
  fi
else
  echo "gsl-config not found, polysomy functionality will be disabled"
  echo "GSL development files not found. Install libgsl-dev (Debian/Ubuntu) or gsl-devel (RPM-based) for polysomy support."
  echo "Continuing with --disable-libgsl to prevent build failure."
fi

echo "Checking for system CHOLMOD..."

# If user provided flags in environment, respect them (no root required)
if [ -n "${CHOLMOD_CPPFLAGS+set}" ] || [ -n "${CHOLMOD_LIBS+set}" ]; then
    echo "Using CHOLMOD flags from environment"
    HAVE_CHOLMOD="yes"
else
    # Prefer pkg-config when available
    if pkg-config --exists cholmod 2>/dev/null; then
        echo "Found CHOLMOD via pkg-config"
        if echo '#include <cholmod.h>
int main() { cholmod_common c; return 0; }' | \
             ${CC} ${CFLAGS} $(pkg-config --cflags cholmod 2>/dev/null) -x c - $(pkg-config --libs cholmod 2>/dev/null) -o /dev/null 2>/dev/null; then
            HAVE_CHOLMOD="yes"
            CHOLMOD_CPPFLAGS=$(pkg-config --cflags cholmod 2>/dev/null)
            CHOLMOD_LIBS=$(pkg-config --libs cholmod 2>/dev/null)
            echo "System CHOLMOD linking test passed - will use system version"
        fi
    else
        echo "pkg-config didn't find cholmod; probing common user/local prefixes"
        # User can set CHOLMOD_PREFIX to help (no root required)
        PREFIXES="${CHOLMOD_PREFIX:-$HOME/.local /usr/local /opt/homebrew /home/linuxbrew/.linuxbrew /usr /opt}"
        for p in $PREFIXES; do
            CPP_CAND=""
            LIB_CAND=""
            if [ -f "$p/include/suitesparse/cholmod.h" ] || [ -f "$p/include/cholmod.h" ]; then
                CPP_CAND="-I${p}/include"
            fi
            if ls "$p/lib"/libcholmod.* >/dev/null 2>&1; then
                LIB_CAND="-L${p}/lib -lcholmod"
            fi
            if [ -n "$CPP_CAND" ] || [ -n "$LIB_CAND" ]; then
                if echo '#include <cholmod.h>
int main() { cholmod_common c; return 0; }' | \
                     ${CC} ${CFLAGS} ${CPP_CAND} -x c - ${LIB_CAND} -o /dev/null 2>/dev/null; then
                    HAVE_CHOLMOD="yes"
                    CHOLMOD_CPPFLAGS="${CPP_CAND}"
                    CHOLMOD_LIBS="${LIB_CAND}"
                    echo "Detected CHOLMOD in $p"
                    break
                fi
            fi
        done

        # Final fallback: try linking with -lcholmod from default system paths
        if [ "${HAVE_CHOLMOD}" != "yes" ]; then
            # On macOS we may need a BLAS/LAPACK framework (Accelerate); detect it
            BLAS_FWK=""
            if [ "$(uname)" = "Darwin" ]; then
                # check common framework locations
                for fwdir in /System/Library/Frameworks /Library/Frameworks; do
                    if [ -d "${fwdir}/Accelerate.framework" ]; then
                        # test compiler link with framework
                        if echo 'int main(void){return 0;}' | ${CC} ${CFLAGS} -x c - -framework Accelerate -o /dev/null 2>/dev/null; then
                            BLAS_FWK="-framework Accelerate"
                            break
                        fi
                    fi
                done
            fi

            # Try default -lcholmod first, if that fails include BLAS framework on macOS
            if echo '#include <cholmod.h>
int main() { cholmod_common c; return 0; }' | \
                 ${CC} ${CFLAGS} -x c - -lcholmod ${BLAS_FWK} -o /dev/null 2>/dev/null; then
                HAVE_CHOLMOD="yes"
                CHOLMOD_LIBS="-lcholmod ${BLAS_FWK}"
                CHOLMOD_CPPFLAGS=""
                echo "Found CHOLMOD via linker -lcholmod${BLAS_FWK:+ with BLAS framework}"
            else
                echo "CHOLMOD linking test failed - continuing without CHOLMOD support"
            fi
        fi
    fi
fi

# If found, export flags so downstream builds (bcftools) see them
if [ "${HAVE_CHOLMOD}" = "yes" ]; then
    export CHOLMOD_CPPFLAGS
    export CHOLMOD_LIBS
    # If on macOS and CHOLMOD was found but BLAS symbols unresolved, ensure framework included
    if [ "$(uname)" = "Darwin" ]; then
        # if CHOLMOD_LIBS doesn't already include a framework, attempt to detect Accelerate
        case " ${CHOLMOD_LIBS} " in
            *framework*) ;;
            *)
                if echo 'int main(void){return 0;}' | ${CC} ${CFLAGS} ${CHOLMOD_CPPFLAGS} -x c - ${CHOLMOD_LIBS} -o /dev/null 2>/dev/null; then
                    : # CHOLMOD builds as-is
                else
                    if echo 'int main(void){return 0;}' | ${CC} ${CFLAGS} ${CHOLMOD_CPPFLAGS} -x c - ${CHOLMOD_LIBS} -framework Accelerate -o /dev/null 2>/dev/null; then
                        CHOLMOD_LIBS="${CHOLMOD_LIBS} -framework Accelerate"
                    fi
                fi
            ;;
        esac
    fi
    echo "Using CHOLMOD flags: CHOLMOD_CPPFLAGS='${CHOLMOD_CPPFLAGS}' CHOLMOD_LIBS='${CHOLMOD_LIBS}'"
fi



echo "----------Configuring HTSlib in $HTSLIB_DIR-----------------"
cd $HTSLIB_DIR

# Detect WebAssembly/r-wasm environment
CONFIGURE_EXTRA_FLAGS=""
HTSLIB_PLUGINS="--enable-plugins"
HTSLIB_S3="--enable-s3"
HTSLIB_GCS="--enable-gcs"

if echo "${CC}" | grep -q "emcc" || echo "${CC}" | grep -q "wasm"; then
    echo "Detected WebAssembly/r-wasm build environment"
    echo "Disabling plugins, S3, and GCS support (not available in wasm)"
    # Disable functions not available in WASM, and force CCHmac to no
    # (AC_CHECK_FUNC incorrectly detects it as available in emscripten,
    # but CommonCrypto/CommonHMAC.h doesn't exist causing build failure)
    CONFIGURE_EXTRA_FLAGS="ac_cv_func_getrandom=no ac_cv_func_fork=no ac_cv_func_vfork=no ac_cv_func_CCHmac=no"
    HTSLIB_PLUGINS="--disable-plugins"
    HTSLIB_S3="--disable-s3"
    HTSLIB_GCS="--disable-gcs"
fi

./configure \
    ${CONFIGURE_ARGS} \
    CFLAGS="${CFLAGS} -Wno-unused-function" \
    ${HTSLIB_PLUGINS} \
    ${HTSLIB_S3} \
    ${HTSLIB_GCS} \
    --prefix="${THISDir}/inst/htslib" \
    ${CONFIGURE_EXTRA_FLAGS}

## copy file instead of symbolic linking
rm -f htscodecs.mk && cp "${HTSLIB_BUNDLED_MK}" htscodecs.mk

export CC="${CC}"
export CPPFLAGS="${CPPFLAGS}"
export AR="${AR}"
export RANLIB="${RANLIB}"
${MAKE} libhts.a libhts.${SHLIB_EXT} install

# Fix dylib install names on macOS
if [ "$(uname)" = "Darwin" ]; then
    echo "Fixing dylib install names for macOS..."
    HTSLIB_INSTALL_DIR="${THISDir}/inst/htslib/lib"
    
    # Fix libhts.3.dylib install name to use @rpath
    if [ -f "${HTSLIB_INSTALL_DIR}/libhts.3.dylib" ]; then
        install_name_tool -id @rpath/libhts.3.dylib "${HTSLIB_INSTALL_DIR}/libhts.3.dylib"
        echo "Fixed libhts.3.dylib install name"
    fi
    
    # Also fix libhts.dylib symlink target if it exists
    if [ -f "${HTSLIB_INSTALL_DIR}/libhts.dylib" ] && [ ! -L "${HTSLIB_INSTALL_DIR}/libhts.dylib" ]; then
        install_name_tool -id @rpath/libhts.dylib "${HTSLIB_INSTALL_DIR}/libhts.dylib"
    fi
fi

#--------------------- Check for SSL library (needed for S3)
SSL_LIBS=""
SSL_CFLAGS=""
echo "Checking for SSL library (required for S3 support)..."

# On macOS, check Homebrew OpenSSL paths first
if [ "$(uname)" = "Darwin" ]; then
    # Check for Homebrew OpenSSL (Apple Silicon path first, then Intel)
    for OPENSSL_PREFIX in /opt/homebrew/opt/openssl@3 /opt/homebrew/opt/openssl@1.1 /opt/homebrew/opt/openssl \
                          /usr/local/opt/openssl@3 /usr/local/opt/openssl@1.1 /usr/local/opt/openssl; do
        if [ -d "${OPENSSL_PREFIX}" ]; then
            echo "Testing Homebrew OpenSSL at ${OPENSSL_PREFIX}..."
            if echo '#include <openssl/hmac.h>
int main(void) { return 0; }' | \
               ${CC} ${CFLAGS} -I${OPENSSL_PREFIX}/include -x c - -L${OPENSSL_PREFIX}/lib -lcrypto -o /dev/null 2>/dev/null; then
                SSL_LIBS="-L${OPENSSL_PREFIX}/lib -lcrypto"
                SSL_CFLAGS="-I${OPENSSL_PREFIX}/include"
                CFLAGS="${CFLAGS} ${SSL_CFLAGS}"
                echo "Found Homebrew OpenSSL at ${OPENSSL_PREFIX}"
                break
            fi
        fi
    done
    
    # Try system LibreSSL if Homebrew OpenSSL not found
    if [ -z "${SSL_LIBS}" ]; then
        if echo '#include <openssl/hmac.h>
int main(void) { return 0; }' | \
           ${CC} ${CFLAGS} -x c - -lcrypto -o /dev/null 2>/dev/null; then
            SSL_LIBS="-lcrypto"
            echo "Found system LibreSSL/OpenSSL"
        fi
    fi
    
    # Try wolfSSL with OpenSSL compatibility layer
    if [ -z "${SSL_LIBS}" ]; then
        for WOLFSSL_PREFIX in /opt/homebrew/opt/wolfssl /usr/local/opt/wolfssl /usr/local; do
            if [ -d "${WOLFSSL_PREFIX}/include/wolfssl" ]; then
                echo "Testing wolfSSL at ${WOLFSSL_PREFIX}..."
                if echo '#include <wolfssl/options.h>
#include <wolfssl/openssl/hmac.h>
int main(void) { return 0; }' | \
                   ${CC} ${CFLAGS} -I${WOLFSSL_PREFIX}/include -I${WOLFSSL_PREFIX}/include/wolfssl -x c - -L${WOLFSSL_PREFIX}/lib -lwolfssl -o /dev/null 2>/dev/null; then
                    SSL_LIBS="-L${WOLFSSL_PREFIX}/lib -lwolfssl"
                    SSL_CFLAGS="-I${WOLFSSL_PREFIX}/include -I${WOLFSSL_PREFIX}/include/wolfssl -DEXTERNAL_OPTS_OPENVPN"
                    CFLAGS="${CFLAGS} ${SSL_CFLAGS}"
                    echo "Found wolfSSL at ${WOLFSSL_PREFIX}"
                    break
                fi
            fi
        done
    fi
else
    # Linux: Try OpenSSL/libcrypto first (most common)
    if echo '#include <openssl/hmac.h>
int main(void) { return 0; }' | \
       ${CC} ${CFLAGS} -x c - -lcrypto -o /dev/null 2>/dev/null; then
        SSL_LIBS="-lcrypto"
        echo "Found OpenSSL/libcrypto"
    # Try GnuTLS
    elif echo '#include <gnutls/gnutls.h>
int main(void) { gnutls_global_init(); return 0; }' | \
       ${CC} ${CFLAGS} -x c - -lgnutls -o /dev/null 2>/dev/null; then
        SSL_LIBS="-lgnutls"
        echo "Found GnuTLS"
    # Try NSS
    elif echo '#include <nss.h>
int main(void) { NSS_Init(NULL); return 0; }' | \
       ${CC} ${CFLAGS} -x c - -lnss3 -o /dev/null 2>/dev/null; then
        SSL_LIBS="-lnss3"
        echo "Found NSS"
    # Try wolfSSL with OpenSSL compatibility layer
    elif echo '#include <wolfssl/options.h>
#include <wolfssl/openssl/hmac.h>
int main(void) { return 0; }' | \
       ${CC} ${CFLAGS} -x c - -lwolfssl -o /dev/null 2>/dev/null; then
        SSL_LIBS="-lwolfssl"
        echo "Found wolfSSL"
    fi
fi

if [ -z "${SSL_LIBS}" ]; then
    echo "NOTE: No SSL library found. S3/GCS support may not work at runtime."
    if [ "$(uname)" = "Darwin" ]; then
        echo "Install OpenSSL via Homebrew: brew install openssl@3"
        echo "Or install wolfSSL: brew install wolfssl"
    else
        echo "Install one of: libssl-dev, libgnutls-dev, libnss3-dev, or libwolfssl-dev"
    fi
fi

EXTRA_LIBS="-lz -lm -lbz2 -llzma -lcurl ${SSL_LIBS}"

if grep -wq "#define HAVE_LIBDEFLATE 1" config.h;then
    EXTRA_LIBS="${EXTRA_LIBS} -ldeflate"
fi

# bcftools static library build against htslib static library
echo "----------Configuring BCFtools in $BCFTOOLS_DIR-----------------"
cd  ${BCFTOOLS_DIR} || exit 1

# Configure bcftools with proper installation directory and plugin paths
BCFTOOLS_PREFIX="${THISDir}/inst/bcftools"
BCFTOOLS_PLUGIN_DIR="plugins"

# Add CHOLMOD and GSL flags if available  
BCFTOOLS_CONFIGURE_FLAGS="--prefix=${BCFTOOLS_PREFIX}"

echo "HAVE_GSL status: ${HAVE_GSL}"
if [ "$HAVE_GSL" = "yes" ]; then
    echo "Enabling GSL in bcftools configure with --enable-libgsl"
    BCFTOOLS_CONFIGURE_FLAGS="${BCFTOOLS_CONFIGURE_FLAGS} --enable-libgsl"
else
    echo "Disabling GSL in bcftools configure with --disable-libgsl"
    BCFTOOLS_CONFIGURE_FLAGS="${BCFTOOLS_CONFIGURE_FLAGS} --disable-libgsl"
fi
echo "Final bcftools configure flags: ${BCFTOOLS_CONFIGURE_FLAGS}"


# Add GSL libraries to EXTRA_LIBS for plugin compilation
if [ "$HAVE_GSL" = "yes" ]; then
    EXTRA_LIBS="${EXTRA_LIBS} ${GSL_LIBS}"
fi

# Ensure GSL flags are available for bcftools configure
if [ "$HAVE_GSL" = "yes" ]; then
    export GSL_CFLAGS="${GSL_CFLAGS}"
    export GSL_LIBS="${GSL_LIBS}"
fi

# Detect compiler type for platform-specific warning flags
COMPILER_TYPE="unknown"
if ${CC} --version 2>&1 | grep -qi "clang"; then
    COMPILER_TYPE="clang"
    echo "Detected Clang compiler"
elif ${CC} --version 2>&1 | grep -qi "gcc\|g++"; then
    COMPILER_TYPE="gcc"
    echo "Detected GCC compiler"
fi

# Set warning suppression flags based on compiler
BCFTOOLS_WARN_FLAGS="-Wno-unused-variable"
if [ "${COMPILER_TYPE}" = "gcc" ]; then
    # GCC-specific warning suppressions
    BCFTOOLS_WARN_FLAGS="${BCFTOOLS_WARN_FLAGS} -Wno-alloc-size-larger-than"
elif [ "${COMPILER_TYPE}" = "clang" ]; then
    # Clang-specific warning suppressions
    BCFTOOLS_WARN_FLAGS="${BCFTOOLS_WARN_FLAGS} -Wno-unused-but-set-variable"
fi

# Detect WebAssembly/r-wasm environment for bcftools
BCFTOOLS_EXTRA_FLAGS=""
if echo "${CC}" | grep -q "emcc" || echo "${CC}" | grep -q "wasm"; then
    echo "Detected WebAssembly/r-wasm build environment for bcftools"
    # Disable functions not available in WASM, and force CCHmac to no
    # (AC_CHECK_FUNC incorrectly detects it as available in emscripten,
    # but CommonCrypto/CommonHMAC.h doesn't exist causing build failure)
    BCFTOOLS_EXTRA_FLAGS="ac_cv_func_getrandom=no ac_cv_func_fork=no ac_cv_func_vfork=no ac_cv_func_CCHmac=no"
fi

CHOLMOD_CPPFLAGS=$CHOLMOD_CPPFLAGS CHOLMOD_LIBS=$CHOLMOD_LIBS CHOLMOD_CPPFLAGS="${CHOLMOD_CPPFLAGS}" \
    ./configure \
    ${CONFIGURE_ARGS} \
    ${BCFTOOLS_CONFIGURE_FLAGS} \
    CFLAGS="${CFLAGS} ${BCFTOOLS_WARN_FLAGS}" \
    CPPFLAGS="${CPPFLAGS}" \
    LDFLAGS="${LDFLAGS}" \
    --enable-shared \
    ${BCFTOOLS_EXTRA_FLAGS}

# Build the bcftools executable and plugins with dependency flags
export CC="${CC}"
export AR="${AR}"
export RANLIB="${RANLIB}"

if [ "$HAVE_GSL" = "yes" ]; then
    export USE_GPL=1
    export GSL_LIBS="${GSL_LIBS}"
fi
${MAKE} -f Makefile bcftools libbcftools.a libbcftools.${SHLIB_EXT}
${MAKE} -f Makefile plugins
${MAKE} -f Makefile install
# if inst/bcftools/lib does not exist, create it
# and copy libbcftools.a there
if [ ! -d "${THISDir}/inst/bcftools/lib" ]; then
    mkdir -p "${THISDir}/inst/bcftools/lib"
fi
cp "${BCFTOOLS_DIR}/libbcftools.a" "${THISDir}/inst/bcftools/lib/"
cp "${BCFTOOLS_DIR}/libbcftools.${SHLIB_EXT}" "${THISDir}/inst/bcftools/lib/"

cd ${THISDir} || exit 1
echo "Create Makevars file"
sed \
    -e "s|@EXTRA_CPPFLAGS@|${CPPFLAGS}|g" \
    -e "s|@EXTRA_LIBS@|${EXTRA_LIBS}|g" \
    -e "s|@HAVE_GSL@|${HAVE_GSL}|g" \
    -e "s|@GSL_LIBS@|${GSL_LIBS}|g" \
    -e "s|@USE_GPL@|${USE_GPL}|g" \
    src/Makevars.in > src/Makevars

# chech if inst/bcftools/libexec/bcftools/pgs.so is present and empty
if [ -f "${THISDir}/inst/bcftools/libexec/bcftools/pgs.${SHLIB_EXT}" ]; then
    if [ ! -s "${THISDir}/inst/bcftools/libexec/bcftools/pgs.${SHLIB_EXT}" ]; then
        echo "Removing empty pgs plugin shared library"
        rm -f "${THISDir}/inst/bcftools/libexec/bcftools/pgs.${SHLIB_EXT}" || true
        rm -f "${THISDir}/inst/bcftools/libexec/bcftools/pgs.so" || true
    fi
fi