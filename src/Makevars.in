HTSLIB_DIR=$(CURDIR)/../inst/htslib
BCFTOOLS_DIR=$(CURDIR)/../inst/bcftools
UNAME_S := $(shell uname -s)


# Set RPATH to include both bcftools/lib and htslib/lib, platform-specific
# Use --disable-new-dtags to force RPATH instead of RUNPATH (higher priority)
ifeq ($(UNAME_S),Darwin)
# macOS: use @loader_path relative paths with -rpath
RPATH = -Wl,-rpath,@loader_path/../bcftools/lib -Wl,-rpath,@loader_path/../htslib/lib
else
RPATH = -Wl,--disable-new-dtags -Wl,-rpath,'$$ORIGIN/../bcftools/lib' -Wl,-rpath,'$$ORIGIN/../htslib/lib'
endif

# Platform-specific linker flags
ifeq ($(UNAME_S), Linux)
  PKG_LIBS_EXTRA=-Wl,--exclude-libs,ALL
else
  PKG_LIBS_EXTRA=
endif

# Base flags - minimal for version functions and HTSlib only
PKG_CPPFLAGS=-I$(HTSLIB_DIR)/include -I$(BCFTOOLS_DIR)/include @EXTRA_CPPFLAGS@
PKG_LIBS=-L$(HTSLIB_DIR)/lib -lhts @EXTRA_LIBS@ $(PKG_LIBS_EXTRA) $(RPATH)



.PHONY: all

all: $(SHLIB)

ifeq ($(UNAME_S),Darwin)
# Fix the reference to libhts to use @rpath instead of absolute path
	install_name_tool -change $(HTSLIB_DIR)/lib/libhts.3.dylib @rpath/libhts.3.dylib $(SHLIB)
endif
