# RBCFTools

RBCFTools provides R bindings to
[bcftools](https://github.com/samtools/bcftools) and
[htslib](https://github.com/samtools/htslib), the standard tools for
reading and manipulating VCF/BCF files. The package bundles these
libraries and command-line tools (bcftools, bgzip, tabix), so no
external installation is required. When compiled with libcurl, remote
file access from S3, GCS, and HTTP URLs is supported.

The package also includes experimental support for streaming VCF/BCF to
Apache Arrow (IPC) format via
[nanoarrow](https://arrow.apache.org/nanoarrow/), with export to Parquet
format using [duckdb](https://duckdb.org/)

## Installation

You can install the development version of RBCFTools from
[GitHub](https://github.com/RGenomicsETL/RBCFTools) with:

``` r
# install.packages("pak")
pak::pak("RGenomicsETL/RBCFTools")
```

## Version Information

``` r
library(RBCFTools)

# Get library versions
bcftools_version()
#> [1] "1.23"
htslib_version()
#> [1] "1.23"
```

## Tool Paths

RBCFTools bundles bcftools and htslib command-line tools. Use the path
functions to locate the executables

``` r
bcftools_path()
#> [1] "/usr/local/lib/R/site-library/RBCFTools/bcftools/bin/bcftools"
bgzip_path()
#> [1] "/usr/local/lib/R/site-library/RBCFTools/htslib/bin/bgzip"
tabix_path()
#> [1] "/usr/local/lib/R/site-library/RBCFTools/htslib/bin/tabix"
# List all available tools
bcftools_tools()
#>  [1] "bcftools"        "color-chrs.pl"   "gff2gff"         "gff2gff.py"     
#>  [5] "guess-ploidy.py" "plot-roh.py"     "plot-vcfstats"   "roh-viz"        
#>  [9] "run-roh.pl"      "vcfutils.pl"     "vrfs-variances"
htslib_tools()
#> [1] "annot-tsv" "bgzip"     "htsfile"   "ref-cache" "tabix"
```

## Capabilities

Check which features were compiled into htslib

``` r
# Get all capabilities as a named list
htslib_capabilities()
#> $configure
#> [1] TRUE
#> 
#> $plugins
#> [1] TRUE
#> 
#> $libcurl
#> [1] TRUE
#> 
#> $s3
#> [1] TRUE
#> 
#> $gcs
#> [1] TRUE
#> 
#> $libdeflate
#> [1] TRUE
#> 
#> $lzma
#> [1] TRUE
#> 
#> $bzip2
#> [1] TRUE
#> 
#> $htscodecs
#> [1] TRUE

# Human-readable feature string
htslib_feature_string()
#> [1] "build=configure libcurl=yes S3=yes GCS=yes libdeflate=yes lzma=yes bzip2=yes plugins=yes plugin-path=/usr/local/lib/R/site-library/RBCFTools/htslib/libexec/htslib: htscodecs=1.6.5"
```

### Feature Constants

Use `HTS_FEATURE_*` constants to check for specific features

``` r
# Check individual features
htslib_has_feature(HTS_FEATURE_LIBCURL)  # Remote file access via libcurl
#> [1] TRUE
htslib_has_feature(HTS_FEATURE_S3)       
#> [1] TRUE
htslib_has_feature(HTS_FEATURE_GCS)      # Google Cloud Storage
#> [1] TRUE
htslib_has_feature(HTS_FEATURE_LIBDEFLATE)
#> [1] TRUE
htslib_has_feature(HTS_FEATURE_LZMA)
#> [1] TRUE
htslib_has_feature(HTS_FEATURE_BZIP2)
#> [1] TRUE
```

These are useful for conditionally enabling features in your code.

## Example Query Remote VCF from S3 using bcftools

With libcurl support, bcftools can directly query remote files. Here we
count variants in a small region from the 1000 Genomes cohort VCF on S3:

``` r
# Setup environment for remote file access (S3/GCS)
setup_hts_env()

# Build S3 URL for 1000 Genomes cohort VCF
s3_base <- "s3://1000genomes-dragen-v3.7.6/data/cohorts/"
s3_path <- "gvcf-genotyper-dragen-3.7.6/hg19/3202-samples-cohort/"
vcf_file <- "3202_samples_cohort_gg_chr22.vcf.gz"
vcf_url <- paste0(s3_base, s3_path, vcf_file)

# Query a small region (chr22:20000000-20100000) and count variants
result <- system2(
  bcftools_path(),
  args = c("view", "-H", "-r", "chr22:20000000-20100000", vcf_url),
  stdout = TRUE,
  stderr = FALSE
)
length(result)
#> [1] 4622
```

## (Experimental) VCF to Arrow

RBCFTools provides streaming VCF/BCF to Apache Arrow (IPC) conversion
via [nanoarrow](https://arrow.apache.org/nanoarrow/). This enables
integration with tools like [duckdb](https://github.com/duckdb/duckdb-r)
and Parquet format convertion.

The Arrow conversion performs VCF spec conformance checks on headers
(similar to htslib’s `bcf_hdr_check_sanity()`) and emits R warnings when
correcting non-conformant fields

### Read VCF as Arrow Stream

Open BCF as Arrow array stream and read the batches

``` r

stream <- vcf_open_arrow(bcf_file, batch_size = 100L)

batch <- stream$get_next()
#> Warning in x$get_schema(): FORMAT/AD should be declared as Number=R per VCF
#> spec; correcting schema
#> Warning in x$get_schema(): FORMAT/GQ should be Type=Integer per VCF spec, but
#> header declares Type=Float; using header type
#> Warning in x$get_schema(): FORMAT/GT should be declared as Number=1 per VCF
#> spec; correcting schema
#> Warning in x$get_schema(): FORMAT/AD should be declared as Number=R per VCF
#> spec; correcting schema
#> Warning in x$get_schema(): FORMAT/GQ should be Type=Integer per VCF spec, but
#> header declares Type=Float; using header type
#> Warning in x$get_schema(): FORMAT/GT should be declared as Number=1 per VCF
#> spec; correcting schema

nanoarrow::convert_array(batch)
#>    CHROM   POS         ID REF ALT QUAL FILTER INFO.DP INFO.AF INFO.CB
#> 1      1 10583 rs58108140   G   A   NA   PASS      NA    NULL    NULL
#> 2      1 11508       <NA>   A   G   NA   PASS      NA    NULL    NULL
#> 3      1 11565       <NA>   G   T   NA   PASS      NA    NULL    NULL
#> 4      1 13116       <NA>   T   G   NA   PASS      NA    NULL    NULL
#> 5      1 13327       <NA>   G   C   NA   PASS      NA    NULL    NULL
#> 6      1 14699       <NA>   C   G   NA   PASS      NA    NULL    NULL
#> 7      1 15274       <NA>   A   T   NA   PASS      NA    NULL    NULL
#> 8      1 15820       <NA>   G   T   NA   PASS      NA    NULL    NULL
#> 9      1 16257       <NA>   G   C   NA   PASS      NA    NULL    NULL
#> 10     1 16378       <NA>   T   C   NA   PASS      NA    NULL    NULL
#> 11     1 28376       <NA>   G   A   NA   PASS      NA    NULL    NULL
#>    INFO.EUR_R2 INFO.AFR_R2 INFO.ASN_R2 INFO.AC INFO.AN samples.HG00098.AD
#> 1           NA          NA          NA    NULL      NA               NULL
#> 2           NA          NA          NA    NULL      NA               NULL
#> 3           NA          NA          NA    NULL      NA               NULL
#> 4           NA          NA          NA    NULL      NA               NULL
#> 5           NA          NA          NA    NULL      NA               NULL
#> 6           NA          NA          NA    NULL      NA               NULL
#> 7           NA          NA          NA    NULL      NA               NULL
#> 8           NA          NA          NA    NULL      NA               NULL
#> 9           NA          NA          NA    NULL      NA               NULL
#> 10          NA          NA          NA    NULL      NA               NULL
#> 11          NA          NA          NA    NULL      NA               NULL
#>    samples.HG00098.DP samples.HG00098.GL samples.HG00098.GQ samples.HG00098.GT
#> 1                  NA               NULL               3.28                0|0
#> 2                  NA               NULL               2.22                1|1
#> 3                  NA               NULL               1.48                0|0
#> 4                  NA               NULL               9.17                0|0
#> 5                  NA               NULL              15.80                0|0
#> 6                  NA               NULL               6.29                0|0
#> 7                  NA               NULL               5.08                1|1
#> 8                  NA               NULL               7.01                0|0
#> 9                  NA               NULL               5.61                0|0
#> 10                 NA               NULL               1.29                1|1
#> 11                 NA               NULL               2.68                1|1
#>    samples.HG00098.GD samples.HG00098.OG samples.HG00100.AD samples.HG00100.DP
#> 1                  NA                ./.               NULL                 NA
#> 2                  NA                ./.               NULL                 NA
#> 3                  NA                ./.               NULL                 NA
#> 4                  NA                ./.               NULL                 NA
#> 5                  NA                ./.               NULL                 NA
#> 6                  NA                ./.               NULL                 NA
#> 7                  NA                ./.               NULL                 NA
#> 8                  NA                ./.               NULL                 NA
#> 9                  NA                ./.               3, 0                  3
#> 10                 NA                ./.               3, 1                  1
#> 11                 NA                ./.               NULL                 NA
#>     samples.HG00100.GL samples.HG00100.GQ samples.HG00100.GT samples.HG00100.GD
#> 1                 NULL               3.28                0|0                 NA
#> 2                 NULL               2.22                1|1                 NA
#> 3                 NULL               1.48                0|0                 NA
#> 4                 NULL               9.17                0|0                 NA
#> 5                 NULL              15.80                0|0                 NA
#> 6                 NULL               6.29                0|0                 NA
#> 7                 NULL               5.08                1|1                 NA
#> 8                 NULL               7.01                0|0                 NA
#> 9  0.00, -0.90, -12.68              13.77                0|0                 NA
#> 10  0.00, -0.30, -3.86               2.95                0|0                 NA
#> 11                NULL               2.68                1|1                 NA
#>    samples.HG00100.OG samples.HG00106.AD samples.HG00106.DP  samples.HG00106.GL
#> 1                 ./.               NULL                 NA                NULL
#> 2                 ./.               NULL                 NA                NULL
#> 3                 ./.               NULL                 NA                NULL
#> 4                 ./.               NULL                 NA                NULL
#> 5                 ./.               2, 0                  2  0.00, -0.60, -8.78
#> 6                 ./.               NULL                 NA                NULL
#> 7                 ./.               NULL                 NA                NULL
#> 8                 ./.               NULL                 NA                NULL
#> 9                 ./.               1, 1                  2 -3.65, -0.60, -4.09
#> 10                ./.               4, 5                  2 -2.70, -0.60, -3.86
#> 11                ./.               NULL                 NA                NULL
#>    samples.HG00106.GQ samples.HG00106.GT samples.HG00106.GD samples.HG00106.OG
#> 1                3.28                0|0                 NA                ./.
#> 2                2.22                1|1                 NA                ./.
#> 3                1.48                0|0                 NA                ./.
#> 4                9.17                0|0                 NA                ./.
#> 5               21.74                0|0                 NA                ./.
#> 6                6.29                0|0                 NA                ./.
#> 7                5.08                1|1                 NA                ./.
#> 8                7.01                0|0                 NA                ./.
#> 9               25.82                0|1                 NA                ./.
#> 10              23.85                1|0                 NA                ./.
#> 11               2.68                1|1                 NA                ./.
```

### Convert to Data Frame

Convert entire BCF to data.frame

``` r
options(warn = -1)  # Suppress warnings
df <- vcf_to_arrow(bcf_file, as = "data.frame")
head(df[, c("CHROM", "POS", "REF", "ALT", "QUAL")])
#>   CHROM   POS REF ALT QUAL
#> 1     1 10583   G   A   NA
#> 2     1 11508   A   G   NA
#> 3     1 11565   G   T   NA
#> 4     1 13116   T   G   NA
#> 5     1 13327   G   C   NA
#> 6     1 14699   C   G   NA
```

### Write to Arrow IPC

Arrow IPC (`.arrows`) format for interoperability with other Arrow tools
using nanoarrow’s native streaming writer

``` r
# Convert BCF to Arrow IPC
vcf_to_arrow_ipc(bcf_file, ipc_file)

# Read back with nanoarrow
ipc_data <- as.data.frame(nanoarrow::read_nanoarrow(ipc_file))
head(ipc_data[, c("CHROM", "POS", "REF", "ALT")])
#>   CHROM   POS REF ALT
#> 1     1 10583   G   A
#> 2     1 11508   A   G
#> 3     1 11565   G   T
#> 4     1 13116   T   G
#> 5     1 13327   G   C
#> 6     1 14699   C   G
```

### Write to Parquet

Using [duckdb](https://github.com/duckdb/duckdb-r) to convert BCF to
parquet file and perform queries on the parquet file

``` r
# 
vcf_to_parquet(bcf_file, parquet_file, compression = "snappy")
#> Wrote 11 rows to /tmp/RtmpsN6WZM/file2c212c42a57d5c.parquet
con <- duckdb::dbConnect(duckdb::duckdb())
pq_bcf <- DBI::dbGetQuery(con, sprintf("SELECT * FROM '%s' LIMIT 100", parquet_file))
duckdb::dbDisconnect(con, shutdown = TRUE)
head(pq_bcf[, c("CHROM", "POS", "REF", "ALT")])
#>   CHROM   POS REF ALT
#> 1     1 10583   G   A
#> 2     1 11508   A   G
#> 3     1 11565   G   T
#> 4     1 13116   T   G
#> 5     1 13327   G   C
#> 6     1 14699   C   G
```

Use `streaming = TRUE` to avoid loading the entire VCF into R memory.
This streams VCF to Arrow IPC (nanoarrow) and then to Parquet via
duckdb, trading memory with serialization overhead using the [duckdb
nanoarrow
extension](https://duckdb.org/community_extensions/extensions/nanoarrow.html)

``` r
vcf_to_parquet(
    bcf_larger,
    tempfile(fileext = ".parquet"),
    streaming = TRUE,
    batch_size = 10000L,
    row_group_size = 100000L,
    compression = "zstd"
)
#> Wrote 11 rows to /tmp/RtmpsN6WZM/file2c212c4252b84f.parquet (streaming mode)
```

### Query with duckdb

``` r
# SQL queries on BCF (requires duckdb package)
vcf_query(bcf_file, "SELECT CHROM, COUNT(*) as n FROM vcf GROUP BY CHROM")
#>   CHROM  n
#> 1     1 11

# Filter variants by position
vcf_query(bcf_file, "SELECT CHROM, POS, REF, ALT FROM vcf  LIMIT 5")
#>   CHROM   POS REF ALT
#> 1     1 10583   G   A
#> 2     1 11508   A   G
#> 3     1 11565   G   T
#> 4     1 13116   T   G
#> 5     1 13327   G   C
```

### Stream Remote VCF to Arrow

``` r
# Stream remote VCF region directly to Arrow from S3
vcf_url <- paste0(s3_base, s3_path, vcf_file)
stream <- vcf_open_arrow(
    vcf_url,
    region = "chr22:16050000-16050500",
    batch_size = 1000L
)

# Convert to data.frame
df <- as.data.frame(nanoarrow::convert_array_stream(stream))
head(df[, c("CHROM", "POS", "REF", "ALT")])
#>   CHROM      POS REF                  ALT
#> 1 chr22 16050036   A C        , <NON_REF>
#> 2 chr22 16050151   T G        , <NON_REF>
#> 3 chr22 16050213   C T        , <NON_REF>
#> 4 chr22 16050219   C A        , <NON_REF>
#> 5 chr22 16050224   A C        , <NON_REF>
#> 6 chr22 16050229   C A        , <NON_REF>
```

## References

- [bcftools documentation](https://samtools.github.io/bcftools/)
- [bcftools GitHub](https://github.com/samtools/bcftools)
- [htslib GitHub](https://github.com/samtools/htslib)
- [arrow-nanoarrow](https://arrow.apache.org/nanoarrow/)

# Package index

## All functions

- [`annot_tsv_path()`](https://rgenomicsetl.github.io/RBCFTools/reference/annot_tsv_path.md)
  : Get Path to annot-tsv Executable
- [`bcftools_bin_dir()`](https://rgenomicsetl.github.io/RBCFTools/reference/bcftools_bin_dir.md)
  : Get Path to bcftools Binary Directory
- [`bcftools_lib_dir()`](https://rgenomicsetl.github.io/RBCFTools/reference/bcftools_lib_dir.md)
  : Get bcftools Library Directory
- [`bcftools_libs()`](https://rgenomicsetl.github.io/RBCFTools/reference/bcftools_libs.md)
  : Get Linker Flags for bcftools Library
- [`bcftools_path()`](https://rgenomicsetl.github.io/RBCFTools/reference/bcftools_path.md)
  : Get Path to bcftools Executable
- [`bcftools_plugins_dir()`](https://rgenomicsetl.github.io/RBCFTools/reference/bcftools_plugins_dir.md)
  : Get Path to bcftools Plugins Directory
- [`bcftools_tools()`](https://rgenomicsetl.github.io/RBCFTools/reference/bcftools_tools.md)
  : List Available bcftools Scripts
- [`bcftools_version()`](https://rgenomicsetl.github.io/RBCFTools/reference/bcftools_version.md)
  : Get bcftools Version
- [`bgzip_path()`](https://rgenomicsetl.github.io/RBCFTools/reference/bgzip_path.md)
  : Get Path to bgzip Executable
- [`htsfile_path()`](https://rgenomicsetl.github.io/RBCFTools/reference/htsfile_path.md)
  : Get Path to htsfile Executable
- [`htslib_bin_dir()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_bin_dir.md)
  : Get Path to htslib Binary Directory
- [`htslib_capabilities()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_capabilities.md)
  : Get htslib Capabilities
- [`htslib_cflags()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_cflags.md)
  : Get Compiler Flags for htslib
- [`htslib_feature_string()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_feature_string.md)
  : Get htslib Feature String
- [`htslib_features()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_features.md)
  : Get htslib Features Bitfield
- [`htslib_has_feature()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_has_feature.md)
  [`HTS_FEATURE_CONFIGURE`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_has_feature.md)
  [`HTS_FEATURE_PLUGINS`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_has_feature.md)
  [`HTS_FEATURE_LIBCURL`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_has_feature.md)
  [`HTS_FEATURE_S3`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_has_feature.md)
  [`HTS_FEATURE_GCS`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_has_feature.md)
  [`HTS_FEATURE_LIBDEFLATE`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_has_feature.md)
  [`HTS_FEATURE_LZMA`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_has_feature.md)
  [`HTS_FEATURE_BZIP2`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_has_feature.md)
  [`HTS_FEATURE_HTSCODECS`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_has_feature.md)
  : Check for a Specific htslib Feature
- [`htslib_include_dir()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_include_dir.md)
  : Get htslib Include Directory
- [`htslib_lib_dir()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_lib_dir.md)
  : Get htslib Library Directory
- [`htslib_libs()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_libs.md)
  : Get Linker Flags for htslib
- [`htslib_plugins_dir()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_plugins_dir.md)
  : Get Path to htslib Plugins Directory
- [`htslib_tools()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_tools.md)
  : List Available htslib Tools
- [`htslib_version()`](https://rgenomicsetl.github.io/RBCFTools/reference/htslib_version.md)
  : Get htslib Version
- [`linking_info()`](https://rgenomicsetl.github.io/RBCFTools/reference/linking_info.md)
  : Get All Linking Information for RBCFTools
- [`print_makevars_config()`](https://rgenomicsetl.github.io/RBCFTools/reference/print_makevars_config.md)
  : Print Makevars Configuration for LinkingTo
- [`ref_cache_path()`](https://rgenomicsetl.github.io/RBCFTools/reference/ref_cache_path.md)
  : Get Path to ref-cache Executable
- [`setup_hts_env()`](https://rgenomicsetl.github.io/RBCFTools/reference/setup_hts_env.md)
  : Setup Environment for Remote File Access
- [`tabix_path()`](https://rgenomicsetl.github.io/RBCFTools/reference/tabix_path.md)
  : Get Path to tabix Executable
- [`vcf_arrow_schema()`](https://rgenomicsetl.github.io/RBCFTools/reference/vcf_arrow_schema.md)
  : Get the Arrow schema for a VCF file
- [`vcf_open_arrow()`](https://rgenomicsetl.github.io/RBCFTools/reference/vcf_open_arrow.md)
  : Create an Arrow stream from a VCF/BCF file
- [`vcf_query()`](https://rgenomicsetl.github.io/RBCFTools/reference/vcf_query.md)
  : Query VCF/BCF with DuckDB
- [`vcf_to_arrow()`](https://rgenomicsetl.github.io/RBCFTools/reference/vcf_to_arrow.md)
  : Read VCF/BCF file into a data frame or list of batches
- [`vcf_to_arrow_ipc()`](https://rgenomicsetl.github.io/RBCFTools/reference/vcf_to_arrow_ipc.md)
  : Write VCF/BCF to Arrow IPC format
- [`vcf_to_parquet()`](https://rgenomicsetl.github.io/RBCFTools/reference/vcf_to_parquet.md)
  : Write VCF/BCF to Parquet format

